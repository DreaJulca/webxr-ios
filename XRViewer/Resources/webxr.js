const _global="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},PRIVATE=Symbol("@@webxr-polyfill/EventTarget");class EventTarget{constructor(){this[PRIVATE]={listeners:new Map}}addEventListener(e,t){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof t)throw new Error("`listener` must be a function");const r=this[PRIVATE].listeners.get(e)||[];r.push(t),this[PRIVATE].listeners.set(e,r)}removeEventListener(e,t){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof t)throw new Error("`listener` must be a function");const r=this[PRIVATE].listeners.get(e)||[];for(let e=r.length;e>=0;e--)r[e]===t&&r.pop()}dispatchEvent(e,t){const r=this[PRIVATE].listeners.get(e)||[],i=[];for(let e=0;e<r.length;e++)i[e]=r[e];for(let e of i)e(t);"function"==typeof this[`on${e}`]&&this[`on${e}`](t)}}const PRIVATE$1=Symbol("@@webxr-polyfill/XR");class XR$1 extends EventTarget{constructor(e){super(),this[PRIVATE$1]={device:e}}async requestDevice(){const e=await this[PRIVATE$1].device;if(e)return e;throw new Error("NotFoundError")}}let now;if("performance"in _global==!1){let e=Date.now();now=(()=>Date.now()-e)}else now=(()=>performance.now());var now$1=now;const PRIVATE$2=Symbol("@@webxr-polyfill/XRPresentationContext");class XRPresentationContext{constructor(e,t,r){this[PRIVATE$2]={canvas:e,ctx:t,glAttribs:r},Object.assign(this,t)}get canvas(){return this[PRIVATE$2].canvas}}let ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array;const degree=Math.PI/180;function create(){let e=new ARRAY_TYPE(16);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function copy(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function identity(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function invert(e,t){let r=t[0],i=t[1],a=t[2],n=t[3],s=t[4],o=t[5],c=t[6],h=t[7],l=t[8],d=t[9],u=t[10],p=t[11],_=t[12],m=t[13],g=t[14],f=t[15],R=r*o-i*s,A=r*c-a*s,E=r*h-n*s,w=i*c-a*o,v=i*h-n*o,b=a*h-n*c,T=l*m-d*_,I=l*g-u*_,y=l*f-p*_,P=d*g-u*m,M=d*f-p*m,O=u*f-p*g,x=R*O-A*M+E*P+w*y-v*I+b*T;return x?(x=1/x,e[0]=(o*O-c*M+h*P)*x,e[1]=(a*M-i*O-n*P)*x,e[2]=(m*b-g*v+f*w)*x,e[3]=(u*v-d*b-p*w)*x,e[4]=(c*y-s*O-h*I)*x,e[5]=(r*O-a*y+n*I)*x,e[6]=(g*E-_*b-f*A)*x,e[7]=(l*b-u*E+p*A)*x,e[8]=(s*M-o*y+h*T)*x,e[9]=(i*y-r*M-n*T)*x,e[10]=(_*v-m*E+f*R)*x,e[11]=(d*E-l*v-p*R)*x,e[12]=(o*I-s*P-c*T)*x,e[13]=(r*P-i*I+a*T)*x,e[14]=(m*A-_*w-g*R)*x,e[15]=(l*w-d*A+u*R)*x,e):null}function multiply(e,t,r){let i=t[0],a=t[1],n=t[2],s=t[3],o=t[4],c=t[5],h=t[6],l=t[7],d=t[8],u=t[9],p=t[10],_=t[11],m=t[12],g=t[13],f=t[14],R=t[15],A=r[0],E=r[1],w=r[2],v=r[3];return e[0]=A*i+E*o+w*d+v*m,e[1]=A*a+E*c+w*u+v*g,e[2]=A*n+E*h+w*p+v*f,e[3]=A*s+E*l+w*_+v*R,A=r[4],E=r[5],w=r[6],v=r[7],e[4]=A*i+E*o+w*d+v*m,e[5]=A*a+E*c+w*u+v*g,e[6]=A*n+E*h+w*p+v*f,e[7]=A*s+E*l+w*_+v*R,A=r[8],E=r[9],w=r[10],v=r[11],e[8]=A*i+E*o+w*d+v*m,e[9]=A*a+E*c+w*u+v*g,e[10]=A*n+E*h+w*p+v*f,e[11]=A*s+E*l+w*_+v*R,A=r[12],E=r[13],w=r[14],v=r[15],e[12]=A*i+E*o+w*d+v*m,e[13]=A*a+E*c+w*u+v*g,e[14]=A*n+E*h+w*p+v*f,e[15]=A*s+E*l+w*_+v*R,e}const PRIVATE$3=Symbol("@@webxr-polyfill/XRDevicePose");class XRDevicePose{constructor(e){this[PRIVATE$3]={polyfill:e,leftViewMatrix:identity(new Float32Array(16)),rightViewMatrix:identity(new Float32Array(16)),poseModelMatrix:identity(new Float32Array(16))}}get poseModelMatrix(){return this[PRIVATE$3].poseModelMatrix}getViewMatrix(e){switch(e.eye){case"left":return this[PRIVATE$3].leftViewMatrix;case"right":return this[PRIVATE$3].rightViewMatrix}throw new Error("view is not a valid XREye")}updateFromFrameOfReference(e){const t=this[PRIVATE$3].polyfill.getBasePoseMatrix(),r=this[PRIVATE$3].polyfill.getBaseViewMatrix("left"),i=this[PRIVATE$3].polyfill.getBaseViewMatrix("right");t&&e.transformBasePoseMatrix(this[PRIVATE$3].poseModelMatrix,t),r&&i&&(e.transformBaseViewMatrix(this[PRIVATE$3].leftViewMatrix,r,this[PRIVATE$3].poseModelMatrix),e.transformBaseViewMatrix(this[PRIVATE$3].rightViewMatrix,i,this[PRIVATE$3].poseModelMatrix))}}const PRIVATE$4=Symbol("@@webxr-polyfill/XRViewport");class XRViewport{constructor(e){this[PRIVATE$4]={target:e}}get x(){return this[PRIVATE$4].target.x}get y(){return this[PRIVATE$4].target.y}get width(){return this[PRIVATE$4].target.width}get height(){return this[PRIVATE$4].target.height}}const XREyes=["left","right"],PRIVATE$5=Symbol("@@webxr-polyfill/XRView");class XRView{constructor(e,t,r){if(!XREyes.includes(t))throw new Error(`XREye must be one of: ${XREyes}`);const i=Object.create(null),a=new XRViewport(i);this[PRIVATE$5]={polyfill:e,eye:t,viewport:a,temp:i,sessionId:r}}get eye(){return this[PRIVATE$5].eye}get projectionMatrix(){return this[PRIVATE$5].polyfill.getProjectionMatrix(this.eye)}_getViewport(e){this[PRIVATE$5].viewport;if(this[PRIVATE$5].polyfill.getViewport(this[PRIVATE$5].sessionId,this.eye,e,this[PRIVATE$5].temp))return this[PRIVATE$5].viewport}}const PRIVATE$6=Symbol("@@webxr-polyfill/XRFrame");class XRFrame$1{constructor(e,t,r){const i=new XRDevicePose(e),a=[new XRView(e,"left",r)];t.immersive&&a.push(new XRView(e,"right",r)),this[PRIVATE$6]={polyfill:e,devicePose:i,views:a,session:t}}get session(){return this[PRIVATE$6].session}get views(){return this[PRIVATE$6].views}getDevicePose(e){return this[PRIVATE$6].devicePose.updateFromFrameOfReference(e),this[PRIVATE$6].devicePose}getInputPose(e,t){return this[PRIVATE$6].polyfill.getInputPose(e,t)}}const PRIVATE$7=Symbol("@@webxr-polyfill/XRStageBoundsPoint");class XRStageBoundsPoint{constructor(e,t){this[PRIVATE$7]={x:e,z:t}}get x(){return this[PRIVATE$7].x}get z(){return this[PRIVATE$7].z}}const PRIVATE$8=Symbol("@@webxr-polyfill/XRStageBounds");class XRStageBounds{constructor(e){const t=[];for(let r=0;r<e.length;r+=2)t.push(new XRStageBoundsPoint(e[r],e[r+1]));this[PRIVATE$8]={geometry:t}}get geometry(){return this[PRIVATE$8].geometry}}class XRCoordinateSystem{constructor(){}getTransformTo(e){throw new Error("Not yet supported")}}const DEFAULT_EMULATION_HEIGHT=1.6,PRIVATE$9=Symbol("@@webxr-polyfill/XRFrameOfReference"),XRFrameOfReferenceTypes=["head-model","eye-level","stage"],XRFrameOfReferenceOptions=Object.freeze({disableStageEmulation:!1,stageEmulationHeight:0});class XRFrameOfReference$1 extends XRCoordinateSystem{constructor(e,t,r,i,a){if(r=Object.assign({},XRFrameOfReferenceOptions,r),!XRFrameOfReferenceTypes.includes(t))throw new Error(`XRFrameOfReferenceType must be one of ${XRFrameOfReferenceTypes}`);if(super(),"stage"===t&&r.disableStageEmulation&&!i)throw new Error("XRFrameOfReference cannot use 'stage' type, if disabling emulation and platform does not provide");const{disableStageEmulation:n,stageEmulationHeight:s}=r;let o=0;"stage"!==t||i||(o=0!==s?s:DEFAULT_EMULATION_HEIGHT),"stage"!==t||i||((i=identity(new Float32Array(16)))[13]=o),this[PRIVATE$9]={disableStageEmulation:n,stageEmulationHeight:s,emulatedHeight:o,type:t,transform:i,polyfill:e,bounds:a},this.onboundschange=void 0}get bounds(){return this[PRIVATE$9].bounds}get emulatedHeight(){return this[PRIVATE$9].emulatedHeight}get type(){return this[PRIVATE$9].type}transformBasePoseMatrix(e,t){if(this[PRIVATE$9].transform)multiply(e,this[PRIVATE$9].transform,t);else switch(this.type){case"head-model":return e!==t&&copy(e,t),void(e[12]=e[13]=e[14]=0);case"eye-level":return void(e!==t&&copy(e,t))}}transformBaseViewMatrix(e,t){let r=this[PRIVATE$9].transform;if(r)invert(e,r),multiply(e,t,e);else{if("head-model"===this.type)return invert(e,t),e[12]=0,e[13]=0,e[14]=0,invert(e,e),e;copy(e,t)}return e}}const PRIVATE$10=Symbol("@@webxr-polyfill/XRSession"),XRSessionCreationOptions=Object.freeze({immersive:!1,outputContext:void 0}),validateSessionOptions=e=>{const{immersive:t,outputContext:r}=e;return!(!t&&!r)&&(void 0===r||r instanceof XRPresentationContext)};class XRSession$1 extends EventTarget{constructor(e,t,r,i){r=Object.assign({},XRSessionCreationOptions,r),super();const{immersive:a,outputContext:n}=r;this[PRIVATE$10]={polyfill:e,device:t,immersive:a,outputContext:n,ended:!1,suspended:!1,suspendedCallback:null,id:i};const s=new XRFrame$1(e,this,this[PRIVATE$10].id);this[PRIVATE$10].frame=s,this[PRIVATE$10].onPresentationEnd=(t=>{if(t!==this[PRIVATE$10].id){this[PRIVATE$10].suspended=!1,this.dispatchEvent("focus",{session:this});const e=this[PRIVATE$10].suspendedCallback;return this[PRIVATE$10].suspendedCallback=null,void(e&&this.requestAnimationFrame(e))}this[PRIVATE$10].ended=!0,e.removeEventListener("@webvr-polyfill/vr-present-end",this[PRIVATE$10].onPresentationEnd),e.removeEventListener("@webvr-polyfill/vr-present-start",this[PRIVATE$10].onPresentationStart),e.removeEventListener("@@webvr-polyfill/input-select-start",this[PRIVATE$10].onSelectStart),e.removeEventListener("@@webvr-polyfill/input-select-end",this[PRIVATE$10].onSelectEnd),this.dispatchEvent("end",{session:this})}),e.addEventListener("@@webxr-polyfill/vr-present-end",this[PRIVATE$10].onPresentationEnd),this[PRIVATE$10].onPresentationStart=(e=>{e!==this[PRIVATE$10].id&&(this[PRIVATE$10].suspended=!0,this.dispatchEvent("blur",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-start",this[PRIVATE$10].onPresentationStart),this[PRIVATE$10].onSelectStart=(e=>{e.sessionId===this[PRIVATE$10].id&&this.dispatchEvent("selectstart",{frame:this[PRIVATE$10].frame,inputSource:e.inputSource})}),e.addEventListener("@@webxr-polyfill/input-select-start",this[PRIVATE$10].onSelectStart),this[PRIVATE$10].onSelectEnd=(e=>{e.sessionId===this[PRIVATE$10].id&&(this.dispatchEvent("selectend",{frame:this[PRIVATE$10].frame,inputSource:e.inputSource}),this.dispatchEvent("select",{frame:this[PRIVATE$10].frame,inputSource:e.inputSource}))}),e.addEventListener("@@webxr-polyfill/input-select-end",this[PRIVATE$10].onSelectEnd),this.onblur=void 0,this.onfocus=void 0,this.onresetpose=void 0,this.onend=void 0,this.onselect=void 0,this.onselectstart=void 0,this.onselectend=void 0}get device(){return this[PRIVATE$10].device}get immersive(){return this[PRIVATE$10].immersive}get outputContext(){return this[PRIVATE$10].outputContext}get depthNear(){return this[PRIVATE$10].polyfill.depthNear}set depthNear(e){this[PRIVATE$10].polyfill.depthNear=e}get depthFar(){return this[PRIVATE$10].polyfill.depthFar}set depthFar(e){this[PRIVATE$10].polyfill.depthFar=e}get environmentBlendMode(){return this[PRIVATE$10].polyfill.environmentBlendMode||"opaque"}get baseLayer(){return this[PRIVATE$10].baseLayer}set baseLayer(e){this[PRIVATE$10].ended||(this[PRIVATE$10].baseLayer=e,this[PRIVATE$10].polyfill.onBaseLayerSet(this[PRIVATE$10].id,e))}async requestFrameOfReference(e,t={}){if(this[PRIVATE$10].ended)return;if(t=Object.assign({},XRFrameOfReferenceOptions,t),!XRFrameOfReferenceTypes.includes(e))throw new TypeError(`XRFrameOfReferenceType must be one of ${XRFrameOfReferenceTypes}`);let r=null,i=null;try{r=await this[PRIVATE$10].polyfill.requestFrameOfReferenceTransform(e,t)}catch(r){if("stage"!==e||t.disableStageEmulation)throw r}return"stage"===e&&r&&(i=this[PRIVATE$10].polyfill.requestStageBounds())&&(i=new XRStageBounds(i)),new XRFrameOfReference$1(this[PRIVATE$10].polyfill,e,t,r,i)}requestAnimationFrame(e){if(!(this[PRIVATE$10].ended||this[PRIVATE$10].suspended&&this[PRIVATE$10].suspendedCallback))return this[PRIVATE$10].suspended&&!this[PRIVATE$10].suspendedCallback&&(this[PRIVATE$10].suspendedCallback=e),this[PRIVATE$10].polyfill.requestAnimationFrame(()=>{this[PRIVATE$10].polyfill.onFrameStart(this[PRIVATE$10].id),e(now$1(),this[PRIVATE$10].frame),this[PRIVATE$10].polyfill.onFrameEnd(this[PRIVATE$10].id)})}cancelAnimationFrame(e){this[PRIVATE$10].ended||this[PRIVATE$10].polyfill.cancelAnimationFrame(e)}getInputSources(){return this[PRIVATE$10].polyfill.getInputSources()}async end(){if(!this[PRIVATE$10].ended)return this.immersive||(this[PRIVATE$10].ended=!0,this[PRIVATE$10].polyfill.removeEventListener("@@webvr-polyfill/vr-present-start",this[PRIVATE$10].onPresentationStart),this[PRIVATE$10].polyfill.removeEventListener("@@webvr-polyfill/vr-present-end",this[PRIVATE$10].onPresentationEnd),this[PRIVATE$10].polyfill.removeEventListener("@@webvr-polyfill/input-select-start",this[PRIVATE$10].onSelectStart),this[PRIVATE$10].polyfill.removeEventListener("@@webvr-polyfill/input-select-end",this[PRIVATE$10].onSelectEnd),this.dispatchEvent("end",{session:this})),this[PRIVATE$10].polyfill.endSession(this[PRIVATE$10].id)}}const PRIVATE$11=Symbol("@@webxr-polyfill/XRDevice");class XRDevice$1 extends EventTarget{constructor(e){if(!e)throw new Error("XRDevice must receive a PolyfilledXRDevice.");super(),this[PRIVATE$11]={polyfill:e,immersiveSession:null,nonImmersiveSessions:new Set},this.ondeactive=void 0}async supportsSession(e={}){return e=Object.assign({},XRSessionCreationOptions,e),validateSessionOptions(e)&&this[PRIVATE$11].polyfill.supportsSession(e)?null:Promise.reject(null)}async requestSession(e){if(e=Object.assign({},XRSessionCreationOptions,e),!validateSessionOptions(e))throw new Error("NotSupportedError");if(this[PRIVATE$11].immersiveSession&&e.immersive)throw new Error("InvalidStateError");const t=await this[PRIVATE$11].polyfill.requestSession(e),r=new XRSession$1(this[PRIVATE$11].polyfill,this,e,t);e.immersive?this[PRIVATE$11].immersiveSession=r:this[PRIVATE$11].nonImmersiveSessions.add(r);const i=()=>{r.immersive?this[PRIVATE$11].immersiveSession=null:this[PRIVATE$11].nonImmersiveSessions.delete(r),r.removeEventListener("end",i)};return r.addEventListener("end",i),r}}let domPointROExport="DOMPointReadOnly"in _global?DOMPointReadOnly:null;if(!domPointROExport){const e=Symbol("@@webxr-polyfill/DOMPointReadOnly");domPointROExport=class{constructor(t,r,i,a){if(1===arguments.length)this[e]={x:t.x,y:t.y,z:t.z,w:t.w};else{if(4!==arguments.length)throw new TypeError("Must supply either 1 or 4 arguments");this[e]={x:t,y:r,z:i,w:a}}}get x(){return this[e].x}get y(){return this[e].y}get z(){return this[e].z}get w(){return this[e].w}}}var DOMPointReadOnly$1=domPointROExport;class XRRay{constructor(e=new DOMPointReadOnly$1(0,0,0,1),t=new DOMPointReadOnly$1(0,0,-1,0),r=new Float32Array(16)){if(!(e instanceof DOMPointReadOnly$1))throw new Error("origin must be a DOMPointReadOnly");if(!(t instanceof DOMPointReadOnly$1))throw new Error("direction must be a DOMPointReadOnly");if(!(r instanceof Float32Array))throw new Error("transformMatrix must be a Float32Array");Object.defineProperties(this,{origin:{value:e,writable:!1},direction:{value:t,writable:!1},transformMatrix:{value:r,writable:!1}})}}const PRIVATE$12=Symbol("@@webxr-polyfill/XRInputPose");class XRInputPose{constructor(e,t){this[PRIVATE$12]={inputSourceImpl:e,targetRay:new XRRay,gripMatrix:t?create():null}}get targetRay(){return this[PRIVATE$12].targetRay}set targetRay(e){this[PRIVATE$12].targetRay=e}get emulatedPosition(){return this[PRIVATE$12].inputSourceImpl.emulatedPosition}get gripMatrix(){return this[PRIVATE$12].gripMatrix}}const PRIVATE$13=Symbol("@@webxr-polyfill/XRInputSource");class XRInputSource{constructor(e){this[PRIVATE$13]={impl:e}}get handedness(){return this[PRIVATE$13].impl.handedness}get targetRayMode(){return this[PRIVATE$13].impl.targetRayMode}}class XRLayer{constructor(){}getViewport(e){return e._getViewport(this)}}const POLYFILLED_COMPATIBLE_XR_DEVICE=Symbol("@@webxr-polyfill/polyfilled-compatible-xr-device"),COMPATIBLE_XR_DEVICE=Symbol("@@webxr-polyfill/compatible-xr-device"),PRIVATE$14=Symbol("@@webxr-polyfill/XRWebGLLayer"),XRWebGLLayerInit=Object.freeze({antialias:!0,depth:!1,stencil:!1,alpha:!0,multiview:!1,framebufferScaleFactor:0});class XRWebGLLayer extends XRLayer{constructor(e,t,r={}){const i=Object.assign({},XRWebGLLayerInit,r);if(!(e instanceof XRSession$1))throw new Error("session must be a XRSession");if(e.ended)throw new Error("InvalidStateError");if(t[POLYFILLED_COMPATIBLE_XR_DEVICE]&&t[COMPATIBLE_XR_DEVICE]!==e.device)throw new Error("InvalidStateError");const a=t.getParameter(t.FRAMEBUFFER_BINDING);super(),this[PRIVATE$14]={context:t,config:i,framebuffer:a}}get context(){return this[PRIVATE$14].context}get antialias(){return this[PRIVATE$14].config.antialias}get depth(){return this[PRIVATE$14].config.depth}get stencil(){return this[PRIVATE$14].config.stencil}get alpha(){return this[PRIVATE$14].config.alpha}get multiview(){return!1}get framebuffer(){return this[PRIVATE$14].framebuffer}get framebufferWidth(){return this[PRIVATE$14].context.drawingBufferWidth}get framebufferHeight(){return this[PRIVATE$14].context.drawingBufferHeight}requestViewportScaling(e){console.warn("requestViewportScaling is not yet implemented")}}var API={XR:XR$1,XRDevice:XRDevice$1,XRSession:XRSession$1,XRFrame:XRFrame$1,XRView:XRView,XRViewport:XRViewport,XRDevicePose:XRDevicePose,XRLayer:XRLayer,XRWebGLLayer:XRWebGLLayer,XRPresentationContext:XRPresentationContext,XRCoordinateSystem:XRCoordinateSystem,XRFrameOfReference:XRFrameOfReference$1,XRStageBounds:XRStageBounds,XRStageBoundsPoint:XRStageBoundsPoint,XRInputPose:XRInputPose,XRInputSource:XRInputSource,XRRay:XRRay};const polyfillSetCompatibleXRDevice=e=>"function"!=typeof e.prototype.setCompatibleXRDevice&&(e.prototype.setCompatibleXRDevice=function(e){return new Promise((t,r)=>{e&&"function"==typeof e.requestSession?t():r()}).then(()=>this[COMPATIBLE_XR_DEVICE]=e)},!0),polyfillGetContext=(e,t)=>{const r=e.prototype.getContext;e.prototype.getContext=function(e,i){if(t&&"xrpresent"===e){let e=r.call(this,t,i);return new XRPresentationContext(this,e,i)}const a=r.call(this,e,i);return a[POLYFILLED_COMPATIBLE_XR_DEVICE]=!0,i&&"compatibleXRDevice"in i&&(a[COMPATIBLE_XR_DEVICE]=i.compatibleXRDevice),a}};function create$1(){let e=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}const forEach=function(){let e=create$1();return function(t,r,i,a,n,s){let o,c;for(r||(r=3),i||(i=0),c=a?Math.min(a*r+i,t.length):t.length,o=i;o<c;o+=r)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],n(e,e,s),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2];return t}}(),isImageBitmapSupported=e=>!(!e.ImageBitmapRenderingContext||!e.createImageBitmap),isMobile=e=>{var t=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0)}(e.navigator.userAgent||e.navigator.vendor||e.opera),t},getXRDevice=async function(e){let t=null;if("xr"in e.navigator)try{t=await e.navigator.xr.requestDevice()}catch(e){}return t},requestDevice=async function(e,t){let r=await getXRDevice(e);return r||null},CONFIG_DEFAULTS={webvr:!0,cardboard:!0},partials=["navigator","HTMLCanvasElement","WebGLRenderingContext"];class WebXRPolyfill{constructor(e,t={}){this.global=e||_global,this.config=Object.freeze(Object.assign({},CONFIG_DEFAULTS,t)),this.nativeWebXR="xr"in this.global.navigator,this.injected=!1,this.nativeWebXR?this.config.cardboard&&isMobile(this.global)&&this._patchRequestDevice():this._injectPolyfill(this.global)}_injectPolyfill(e){if(!partials.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${partials}`);for(const t of Object.keys(API))void 0!==e[t]?console.warn(`${t} already defined on global.`):e[t]=API[t];if(polyfillSetCompatibleXRDevice(e.WebGLRenderingContext)){const t=isImageBitmapSupported(e)?"bitmaprenderer":"2d";polyfillGetContext(e.HTMLCanvasElement,t),e.OffscreenCanvas&&polyfillGetContext(e.OffscreenCanvas,null),e.WebGL2RenderingContext&&polyfillSetCompatibleXRDevice(e.WebGL2RenderingContext)}this.injected=!0,this._patchRequestDevice()}_patchRequestDevice(){const e=requestDevice(this.global,this.config);this.xr=new XR$1(e),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}}const EPSILON$1=1e-6;let ARRAY_TYPE$1="undefined"!=typeof Float32Array?Float32Array:Array;const degree$1=Math.PI/180;function create$2(){let e=new ARRAY_TYPE$1(16);return ARRAY_TYPE$1!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function clone$2(e){let t=new ARRAY_TYPE$1(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function copy$2(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function identity$1(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function invert$1(e,t){let r=t[0],i=t[1],a=t[2],n=t[3],s=t[4],o=t[5],c=t[6],h=t[7],l=t[8],d=t[9],u=t[10],p=t[11],_=t[12],m=t[13],g=t[14],f=t[15],R=r*o-i*s,A=r*c-a*s,E=r*h-n*s,w=i*c-a*o,v=i*h-n*o,b=a*h-n*c,T=l*m-d*_,I=l*g-u*_,y=l*f-p*_,P=d*g-u*m,M=d*f-p*m,O=u*f-p*g,x=R*O-A*M+E*P+w*y-v*I+b*T;return x?(x=1/x,e[0]=(o*O-c*M+h*P)*x,e[1]=(a*M-i*O-n*P)*x,e[2]=(m*b-g*v+f*w)*x,e[3]=(u*v-d*b-p*w)*x,e[4]=(c*y-s*O-h*I)*x,e[5]=(r*O-a*y+n*I)*x,e[6]=(g*E-_*b-f*A)*x,e[7]=(l*b-u*E+p*A)*x,e[8]=(s*M-o*y+h*T)*x,e[9]=(i*y-r*M-n*T)*x,e[10]=(_*v-m*E+f*R)*x,e[11]=(d*E-l*v-p*R)*x,e[12]=(o*I-s*P-c*T)*x,e[13]=(r*P-i*I+a*T)*x,e[14]=(m*A-_*w-g*R)*x,e[15]=(l*w-d*A+u*R)*x,e):null}function multiply$2(e,t,r){let i=t[0],a=t[1],n=t[2],s=t[3],o=t[4],c=t[5],h=t[6],l=t[7],d=t[8],u=t[9],p=t[10],_=t[11],m=t[12],g=t[13],f=t[14],R=t[15],A=r[0],E=r[1],w=r[2],v=r[3];return e[0]=A*i+E*o+w*d+v*m,e[1]=A*a+E*c+w*u+v*g,e[2]=A*n+E*h+w*p+v*f,e[3]=A*s+E*l+w*_+v*R,A=r[4],E=r[5],w=r[6],v=r[7],e[4]=A*i+E*o+w*d+v*m,e[5]=A*a+E*c+w*u+v*g,e[6]=A*n+E*h+w*p+v*f,e[7]=A*s+E*l+w*_+v*R,A=r[8],E=r[9],w=r[10],v=r[11],e[8]=A*i+E*o+w*d+v*m,e[9]=A*a+E*c+w*u+v*g,e[10]=A*n+E*h+w*p+v*f,e[11]=A*s+E*l+w*_+v*R,A=r[12],E=r[13],w=r[14],v=r[15],e[12]=A*i+E*o+w*d+v*m,e[13]=A*a+E*c+w*u+v*g,e[14]=A*n+E*h+w*p+v*f,e[15]=A*s+E*l+w*_+v*R,e}function fromTranslation$1(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function fromZRotation$1(e,t){let r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function getTranslation$1(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function getRotation$1(e,t){let r=t[0]+t[5]+t[10],i=0;return r>0?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i),e}function equals$4(e,t){let r=e[0],i=e[1],a=e[2],n=e[3],s=e[4],o=e[5],c=e[6],h=e[7],l=e[8],d=e[9],u=e[10],p=e[11],_=e[12],m=e[13],g=e[14],f=e[15],R=t[0],A=t[1],E=t[2],w=t[3],v=t[4],b=t[5],T=t[6],I=t[7],y=t[8],P=t[9],M=t[10],O=t[11],x=t[12],S=t[13],C=t[14],V=t[15];return Math.abs(r-R)<=EPSILON$1*Math.max(1,Math.abs(r),Math.abs(R))&&Math.abs(i-A)<=EPSILON$1*Math.max(1,Math.abs(i),Math.abs(A))&&Math.abs(a-E)<=EPSILON$1*Math.max(1,Math.abs(a),Math.abs(E))&&Math.abs(n-w)<=EPSILON$1*Math.max(1,Math.abs(n),Math.abs(w))&&Math.abs(s-v)<=EPSILON$1*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(o-b)<=EPSILON$1*Math.max(1,Math.abs(o),Math.abs(b))&&Math.abs(c-T)<=EPSILON$1*Math.max(1,Math.abs(c),Math.abs(T))&&Math.abs(h-I)<=EPSILON$1*Math.max(1,Math.abs(h),Math.abs(I))&&Math.abs(l-y)<=EPSILON$1*Math.max(1,Math.abs(l),Math.abs(y))&&Math.abs(d-P)<=EPSILON$1*Math.max(1,Math.abs(d),Math.abs(P))&&Math.abs(u-M)<=EPSILON$1*Math.max(1,Math.abs(u),Math.abs(M))&&Math.abs(p-O)<=EPSILON$1*Math.max(1,Math.abs(p),Math.abs(O))&&Math.abs(_-x)<=EPSILON$1*Math.max(1,Math.abs(_),Math.abs(x))&&Math.abs(m-S)<=EPSILON$1*Math.max(1,Math.abs(m),Math.abs(S))&&Math.abs(g-C)<=EPSILON$1*Math.max(1,Math.abs(g),Math.abs(C))&&Math.abs(f-V)<=EPSILON$1*Math.max(1,Math.abs(f),Math.abs(V))}function create$3(){let e=new ARRAY_TYPE$1(3);return ARRAY_TYPE$1!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function set$3(e,t,r,i){return e[0]=t,e[1]=r,e[2]=i,e}function add$3(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function subtract$3(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function transformMat4$1(e,t,r){let i=t[0],a=t[1],n=t[2],s=r[3]*i+r[7]*a+r[11]*n+r[15];return s=s||1,e[0]=(r[0]*i+r[4]*a+r[8]*n+r[12])/s,e[1]=(r[1]*i+r[5]*a+r[9]*n+r[13])/s,e[2]=(r[2]*i+r[6]*a+r[10]*n+r[14])/s,e}function transformMat3$1(e,t,r){let i=t[0],a=t[1],n=t[2];return e[0]=i*r[0]+a*r[3]+n*r[6],e[1]=i*r[1]+a*r[4]+n*r[7],e[2]=i*r[2]+a*r[5]+n*r[8],e}function equals$5(e,t){let r=e[0],i=e[1],a=e[2],n=t[0],s=t[1],o=t[2];return Math.abs(r-n)<=EPSILON$1*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(i-s)<=EPSILON$1*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(a-o)<=EPSILON$1*Math.max(1,Math.abs(a),Math.abs(o))}const forEach$1=function(){let e=create$3();return function(t,r,i,a,n,s){let o,c;for(r||(r=3),i||(i=0),c=a?Math.min(a*r+i,t.length):t.length,o=i;o<c;o+=r)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],n(e,e,s),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2];return t}}();class XRAnchor extends EventTarget{constructor(e,t=null,r=0){super(),this._uid=t||XRAnchor._generateUID(),this._transform=clone$2(e),this._timestamp=r,this._poseChanged=!0,this._deleted=!1,this._placeholder=!1}get deleted(){return this._deleted}set deleted(e){this._deleted=e}get placeholder(){return this._placeholder}set placeholder(e){this._placeholder=e}isMesh(){return!1}get timeStamp(){return this._timestamp}get changed(){return this._poseChanged}clearChanged(){this._poseChanged=!1}get modelMatrix(){return this._transform}updateModelMatrix(e,t){if(this._timestamp=t,!this._deleted&&!equals$4(this._transform,e)){this._poseChanged=!0;for(var r=0;r<16;r++)this._transform[r]=e[r];try{this.dispatchEvent("update",{source:this})}catch(e){console.error("XRAnchor update event error",e)}}}notifyOfRemoval(){try{this.dispatchEvent("remove",{source:this})}catch(e){console.error("XRAnchor removed event error",e)}}get position(){return getTranslation$1(new Float32Array(3),this._poseMatrix)}get orientation(){return getRotation$1(new Float32Array(4),this._poseMatrix)}get uid(){return this._uid}static _generateUID(){return"anchor-"+(new Date).getTime()+"-"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}}class XRAnchorOffset extends XRAnchor{constructor(e,t=null){super(t,null),this._anchor=e,this._timestamp=e.timeStamp,this._tempArray=new Float32Array(16),this._offsetMatrix=create$2(),t&&copy$2(this._offsetMatrix,t),multiply$2(this._transform,e.modelMatrix,this._offsetMatrix),this._handleAnchorUpdateListener=this._handleAnchorUpdate.bind(this),this._notifyOfRemovalListener=this.notifyOfRemoval.bind(this),this._handleReplaceAnchorListener=this._handleReplaceAnchor.bind(this),e.addEventListener("update",this._handleAnchorUpdateListener),e.addEventListener("removal",this._notifyOfRemovalListener),e.addEventListener("replaceAnchor",this._handleReplaceAnchorListener)}_handleReplaceAnchor(e){this._anchor.removeEventListener("update",this._handleAnchorUpdateListener),this._anchor.removeEventListener("removal",this._notifyOfRemovalListener),this._anchor.removeEventListener("replaceAnchor",this._handleReplaceAnchorListener),this._anchor=e,this._anchor.addEventListener("update",this._handleAnchorUpdateListener),this._anchor.addEventListener("removal",this._notifyOfRemovalListener),this._anchor.addEventListener("replaceAnchor",this._handleReplaceAnchorListener)}_handleAnchorUpdate(){multiply$2(this._tempArray,this._anchor.modelMatrix,this._offsetMatrix),this.updateModelMatrix(this._tempArray,Math.max(this._anchor.timeStamp,this._timestamp))}get modelMatrix(){return this._transform}clearChanged(){super.clearChanged()}get anchor(){return this._anchor}get offsetMatrix(){return this._offsetMatrix}set offsetMatrix(e){copy$2(this._offsetMatrix,e),this._handleAnchorUpdate()}}var _useGeomArrays=!1;class XRMesh extends XRAnchor{static setUseGeomArrays(){_useGeomArrays=!0}static useGeomArrays(){return _useGeomArrays}constructor(e,t,r=null,i=0){super(e,r,i),this._useGeomArrays=_useGeomArrays,this._vertexCountChanged=!0,this._vertexPositionsChanged=!0,this._triangleIndicesChanged=!0,this._textureCoordinatesChanged=!0,this._vertexPositions=[],this._triangleIndices=[],this._textureCoordinates=[],this._vertexNormalsChanged=!0,this._vertexNormals=[],t&&(this._geometry=t,this._updateGeometry(this._geometry))}isMesh(){return!0}get changed(){return super.changed||this._vertexPositionsChanged||this._vertexNormalsChanged||this._triangleIndicesChanged||this._vertexCountChanged}clearChanged(){super.clearChanged(),this._vertexPositionsChanged=!1,this._vertexNormalsChanged=!1,this._triangleIndicesChanged=!1,this._vertexCountChanged=!1}get vertexCountChanged(){return this._vertexCountChanged}get vertexPositionsChanged(){return this._vertexPositionsChanged}get triangleIndicesChanged(){this._triangleIndicesChanged}get textureCoordinatesChanged(){this._textureCoordinatesChanged}get vertexNormalsChanged(){this._vertexNormalsChanged}get vertexPositions(){return this._vertexPositions}get vertexNormals(){return this._vertexNormals}get triangleIndices(){return this._triangleIndices}get textureCoordinates(){return this._textureCoordinates}get vertexCount(){return this._vertexPositions.length}get triangleCount(){return this._triangleIndices.length}get hasNormals(){return this._vertexNormals.length>0}get hasTextureCoordinates(){return this._textureCoordinates.length>0}_updateGeometry(e){this._geometry=e;let t=e;if(0==t.vertexCount)return void(this._vertexPositions.length>0&&(this._vertexPositionsChanged=!0,this._vertexNormalsChanged=!0,this._triangleIndicesChanged=!0,this._textureCoordinatesChanged=!0,this._vertexPositions=[],this._vertexNormals=[],this.triangleIndices=[],this._textureCoordinates=[]));if(void 0===t.vertexCount)return void console.warn("bad geometry data passed to XRMesh._updateGeometry: no vertex count",t);let r=0;if(this._vertexPositions.length!=3*t.vertexCount){if(void 0===t.vertices)return void console.warn("bad geometry data passed to XRMesh._updateGeometry: no vertices",t);this._vertexCountChanged=!0,this._vertexPositionsChanged=!0,this._vertexPositions=new Float32Array(3*t.vertexCount),t.textureCoordinates&&(this._textureCoordinatesChanged=!0,this._textureCoordinates=new Float32Array(2*t.vertexCount))}else if(this._useGeomArrays)this._vertexPositionsChanged=void 0!==t.vertices&&!XRMesh.arrayFuzzyEquals(this._vertexPositions,t.vertices),this._textureCoordinatesChanged=void 0!==t.textureCoordinates&&!XRMesh.arrayFuzzyEquals(this._textureCoordinates,t.textureCoordinates);else{if(this._vertexPositionsChanged=!1,t.vertices){r=0;for(var i=0,a=t.vertexCount;i<a;i++)if(Math.abs(this._vertexPositions[r++]-t.vertices[i].x)>EPSILON$1||Math.abs(this._vertexPositions[r++]-t.vertices[i].y)>EPSILON$1||Math.abs(this._vertexPositions[r++]-t.vertices[i].z)>EPSILON$1){this._vertexPositionsChanged=!0;break}}if(this._textureCoordinatesChanged=!1,t.textureCoordinates){r=0;for(i=0,a=t.vertexCount;i<a;i++)if(Math.abs(this._textureCoordinates[r++]-t.textureCoordinates[i].x)>EPSILON$1||Math.abs(this._textureCoordinates[r++]-t.textureCoordinates[i].x)>EPSILON$1){this._textureCoordinatesChanged=!0;break}}}if(t.triangleCount?this._triangleIndices.length!=3*t.triangleCount?(this._triangleIndicesChanged=!0,this._triangleIndices=(XRMesh.arrayMax(t.triangleIndices),new Uint32Array(3*t.triangleCount))):this._triangleIndicesChanged=t.triangleIndicies&&!XRMesh.arrayEquals(this._triangleIndices,t.triangleIndices):this._triangleIndicesChanged=!1,this._vertexPositionsChanged)if(this._useGeomArrays)this._vertexPositions.set(t.vertices);else{r=0;for(let e of t.vertices)this._vertexPositions[r++]=e.x,this._vertexPositions[r++]=e.y,this._vertexPositions[r++]=e.z}if(this._textureCoordinatesChanged)if(r=0,this._useGeomArrays)this._textureCoordinates.set(t.textureCoordinates);else for(let e of t.textureCoordinates)this._textureCoordinates[r++]=e.x,this._textureCoordinates[r++]=e.y;this._triangleIndicesChanged&&this._triangleIndices.set(t.triangleIndices)}static arrayMax(e){if(0===e.length)return-1/0;for(var t=e[0],r=1,i=e.length;r<i;++r)e[r]>t&&(t=e[r]);return t}static arrayEquals(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var r=0,i=e.length;r<i;r++)if(e[r]!=t[r])return!1;return!0}static arrayFuzzyEquals(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var r=0,i=e.length;r<i;r++)if(Math.abs(e[r]-t[r])>EPSILON$1)return!1;return!0}}class XRFaceMesh extends XRMesh{constructor(e,t,r,i=null,a=0){super(e,t,i,a),this._blendShapes={},this._blendShapesChanged=!0,this._updateBlendShapes(r)}get changed(){return super.changed||this._blendShapesChanged}clearChanged(){super.clearChanged(),this._blendShapesChanged=!1}_updateBlendShapes(e){for(let i=0;i<blendShapeNames.length;i++){let a=blendShapeNames[i];var t=this._blendShapes[a],r=e[i];Math.abs(t-r)>EPSILON$1&&(this._blendShapesChanged=!0,this._blendShapes[a]=r)}}updateFaceData(e,t,r,i){super.updateModelMatrix(e,i),void 0===t.vertexCount&&(t.vertexCount=t.vertices.length/(XRMesh.useGeomArrays()?3:1)),this._updateGeometry(t),this._updateBlendShapes(r)}get blendShapes(){return this._blendShapes}}const blendShapeNames=["browDownLeft","browDownRight","browInnerUp","browOuterUpLeft","browOuterUpRight","cheekPuff","cheekSquintLeft","cheekSquintRight","eyeBlinkLeft","eyeBlinkRight","eyeLookDownLeft","eyeLookDownRight","eyeLookInLeft","eyeLookInRight","eyeLookOutLeft","eyeLookOutRight","eyeLookUpLeft","eyeLookUpRight","eyeSquintLeft","eyeSquintRight","eyeWideLeft","eyeWideRight","jawForward","jawLeft","jawOpen","jawRight","mouthClose","mouthDimpleLeft","mouthDimpleRight","mouthFrownLeft","mouthFrownRight","mouthFunnel","mouthLeft","mouthLowerDownLeft","mouthLowerDownRight","mouthPressLeft","mouthPressRight","mouthPucker","mouthRight","mouthRollLower","mouthRollUpper","mouthShrugLower","mouthShrugUpper","mouthSmileLeft","mouthSmileRight","mouthStretchLeft","mouthStretchRight","mouthUpperUpLeft","mouthUpperUpRight","noseSneerLeft","noseSneerRight"];class XRHitResult{constructor(e=null,t=null,r){this._hit=t,this._timestamp=r,this._hitMatrix=clone$2(e)}get hitMatrix(){return this._hitMatrix}get timeStamp(){return this._timestamp}}class XRImageAnchor extends XRAnchor{}class XRLightEstimate{constructor(){this._ambientLightIntensity=1}set ambientIntensity(e){this._ambientLightIntensity=e/1e3}get ambientIntensity(){return this._ambientLightIntensity}getAmbientColorTemperature(){throw new Error("Not implemented")}}function create$4(){let e=new ARRAY_TYPE$1(4);return ARRAY_TYPE$1!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function fromValues$4(e,t,r,i){let a=new ARRAY_TYPE$1(4);return a[0]=e,a[1]=t,a[2]=r,a[3]=i,a}function transformMat4$2(e,t,r){let i=t[0],a=t[1],n=t[2],s=t[3];return e[0]=r[0]*i+r[4]*a+r[8]*n+r[12]*s,e[1]=r[1]*i+r[5]*a+r[9]*n+r[13]*s,e[2]=r[2]*i+r[6]*a+r[10]*n+r[14]*s,e[3]=r[3]*i+r[7]*a+r[11]*n+r[15]*s,e}const forEach$2=function(){let e=create$4();return function(t,r,i,a,n,s){let o,c;for(r||(r=4),i||(i=0),c=a?Math.min(a*r+i,t.length):t.length,o=i;o<c;o+=r)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],e[3]=t[o+3],n(e,e,s),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2],t[o+3]=e[3];return t}}();class XRPlaneMesh extends XRMesh{constructor(e,t,r,i,a,n=null,s=0){super(e,null,n,s),this._center=t,this._extent=r,this._alignment=i,this._planeFeatureChanged=!0,this._yAxis=fromValues$4(0,1,0,0),this._normal=create$4(),this._boundaryVerticesChanged=!0,this._boundaryVertices=[],this._geometry=a,this._updateGeometry(this._geometry)}get changed(){return super.changed||this._planeFeatureChanged}clearChanged(){super.clearChanged(),this._planeFeatureChanged=!1}updatePlaneData(e,t,r,i,a,n){super.updateModelMatrix(e,n),equals$5(this._center,t)&&equals$5(this._extent,r)&&!this._alignment||(this._center=t,this._extent=r,this._alignment=i,this._planeFeatureChanged=!0),this._updateGeometry(a)}get center(){return this._center}get extent(){return this._extent}get alignment(){return this._alignment}get boundaryVertices(){return this._boundaryVertices}get boundaryVerticesChanged(){return this._boundaryVerticesChanged}get boundaryVertexCount(){return this._boundaryVertices.length}_updateGeometry(e){super._updateGeometry(e);let t=e;const r=transformMat4$2(this._normal,this._yAxis,this._transform),i=r[0],a=r[1],n=r[2];let s=0;if(this._boundaryVertices.length!=3*t.boundaryVertexCount)this._boundaryVerticesChanged=!0,this._boundaryVertices=new Float32Array(3*t.vertexCount),this._vertexNormalsChanged=!0,this._vertexNormals=new Float32Array(3*t.vertexCount);else if(this._vertexNormalsChanged=Math.abs(this._vertexNormals[0]-i)>EPSILON$1||Math.abs(this._vertexNormals[1]-a)>EPSILON$1||Math.abs(this._vertexNormals[2]-n)>EPSILON$1,this._useGeomArrays)this._vertexPositionsChanged=!XRMesh.arrayFuzzyEquals(this._boundaryVertices,t.boundaryVertices);else{this._boundaryVerticesChanged=!1,s=0;for(var o=0,c=t.vertexCount;o<c;o++)if(Math.abs(this._boundaryVertices[s++]-t.boundaryVertices[o].x)>EPSILON$1||Math.abs(this._boundaryVertices[s++]-t.boundaryVertices[o].y)>EPSILON$1||Math.abs(this._boundaryVertices[s++]-t.boundaryVertices[o].z)>EPSILON$1){this._boundaryVerticesChanged=!0;break}}if(this._boundaryVerticesChanged)if(this._useGeomArrays)this._boundaryVertices.set(t.boundaryVertices);else{s=0;for(let e of t.boundaryVertices)this._boundaryVertices[s++]=e.x,this._boundaryVertices[s++]=e.y,this._boundaryVertices[s++]=e.z}if(this._vertexNormalsChanged){s=0;for(o=0;o<t.vertexCount;o++)this._vertexNormals[s++]=i,this._vertexNormals[s++]=a,this._vertexNormals[s++]=n}}}class base64{static decodeLength(e){return e.length/4*3}static decodeArrayBuffer(e,t){var r=e.length/4*3;return t&&t.byteLength==r||(t=new ArrayBuffer(r)),this.decode(e,t),t}static removePaddingChars(e){return 64==this._keyStr.indexOf(e.charAt(e.length-1))?e.substring(0,e.length-1):e}static decode(e,t){e=this.removePaddingChars(e),e=this.removePaddingChars(e);var r,i,a,n,s,o,c,h=parseInt(e.length/4*3,10),l=0,d=0;for(r=t?new Uint8Array(t):new Uint8Array(h),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),l=0;l<h;l+=3)i=this._keyStr.indexOf(e.charAt(d++))<<2|(s=this._keyStr.indexOf(e.charAt(d++)))>>4,a=(15&s)<<4|(o=this._keyStr.indexOf(e.charAt(d++)))>>2,n=(3&o)<<6|(c=this._keyStr.indexOf(e.charAt(d++))),r[l]=i,64!=o&&(r[l+1]=a),64!=c&&(r[l+2]=n);return r}static encode(e){var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=e;e instanceof ArrayBuffer?i=new Uint8Array(arrayBuffer):e instanceof ImageData&&(i=e.data);for(var a,n=e.length,s=n%3,o=n-s,c=0;c<o;c+=3)t+=r[(16515072&(a=i[c]<<16|i[c+1]<<8|i[c+2]))>>18]+r[(258048&a)>>12]+r[(4032&a)>>6]+r[63&a];return 1==s?t+=r[(252&(a=i[o]))>>2]+r[(3&a)<<4]+"==":2==s&&(t+=r[(64512&(a=i[o]<<8|i[o+1]))>>10]+r[(1008&a)>>4]+r[(15&a)<<2]+"="),t}}base64._keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var _ab=[];class XRVideoFrame{constructor(e,t,r,i){this._buffers=e;for(var a=0;a<e.length;a++)if(e[a]._buffer=e[a].buffer,e[a].buffer=null,e[a]._abCache||"string"!=typeof e[a]._buffer){if(!e[a]._abCache&&e[a]._buffer instanceof ImageData){var n=e[a]._buffer.data;for(h=n.length,l=0;l<_ab.length;l++)if(_ab[l].byteLength==h){e[a]._abCache=_ab[l],_ab.splice(l,1);break}var s=e[a]._abCache?e[a]._abCache:new ArrayBuffer(h);e[a]._abCache=null;for(var o=new Uint8Array(s),c=0;c<h;c++)o[c]=n[c];e[a]._buffer=s}}else for(var h=base64.decodeLength(e[a]._buffer),l=0;l<_ab.length;l++)if(_ab[l].byteLength==h){e[a]._abCache=_ab[l],_ab.splice(l,1);break}this._pixelFormat=t,this._timestamp=r,this._camera=i}static createFromMessage(e){return new this(e.data.buffers,e.data.pixelFormat,e.data.timestamp,e.data.camera)}numBuffers(){this._buffers.length}buffer(e){if(e>=0&&e<this._buffers.length){var t=this._buffers[e];return t.buffer||("string"==typeof t._buffer?(t._buffer=base64.decodeArrayBuffer(t._buffer,t._abCache),t._abCache=null,t.buffer=new Uint8Array(t._buffer)):t._buffer instanceof ArrayBuffer?t.buffer=new Uint8Array(t._buffer):t._buffer instanceof ImageData&&(t.buffer=ImageData.data)),t}return null}get pixelFormat(){return this._pixelFormat}get timestamp(){return this._timestamp}get camera(){return this._camera}release(){for(var e=this._buffers,t=0;t<e.length;t++)e[t]._buffer instanceof ArrayBuffer&&e[t]._buffer.byteLength>0&&_ab.push(e[t]._buffer),e[t]._abCache instanceof ArrayBuffer&&e[t]._abCache.byteLength>0&&_ab.push(e[t]._abCache)}postMessageToWorker(e,t){var r=Object.assign({},t||{});r.buffers=this._buffers,r.timestamp=this._timestamp,r.pixelFormat=this._pixelFormat,r.camera=this._camera;for(var i=[],a=0;a<r.buffers.length;a++)r.buffers[a].buffer=r.buffers[a]._buffer,(r.buffers[a]._buffer instanceof ArrayBuffer||r.buffers[a]._buffer instanceof ImageData)&&i.push(r.buffers[a]._buffer),r.buffers[a]._buffer=null,r.buffers[a]._abCache instanceof ArrayBuffer&&i.push(r.buffers[a]._abCache);e.postMessage(r,i)}postReplyMessage(e){var t=Object.assign({},e);t.buffers=this._buffers,t.timestamp=this._timestamp,t.pixelFormat=this._pixelFormat,t.camera=this._camera;for(var r=[],i=0;i<t.buffers.length;i++)t.buffers[i].buffer=null,(t.buffers[i]._buffer instanceof ArrayBuffer||t.buffers[i]._buffer instanceof ImageData)&&(r.push(t.buffers[i]._buffer),t.buffers[i].buffer=t.buffers[i]._buffer),t.buffers[i]._buffer=null,t.buffers[i]._abCache instanceof ArrayBuffer&&r.push(t.buffers[i]._abCache);postMessage(t,r)}}function create$5(){let e=new ARRAY_TYPE$1(9);return ARRAY_TYPE$1!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function fromMat4(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function MapzenTerrariumTerrainProvider(e){this._token=e.token,this._url=e.url;var t=Cesium.Resource.createIfNeeded(e.url);this._resource=t,this._tilingScheme=e.tilingScheme,Cesium.defined(this._tilingScheme)||(this._tilingScheme=new Cesium.WebMercatorTilingScheme({numberOfLevelZeroTilesX:1,numberOfLevelZeroTilesY:1,ellipsoid:Cesium.defaultValue(e.ellipsoid,Cesium.Ellipsoid.WGS84)})),this._heightmapWidth=64,this._levelZeroMaximumGeometricError=Cesium.TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(this._tilingScheme.ellipsoid,this._heightmapWidth,this._tilingScheme.getNumberOfXTilesAtLevel(0)),this._proxy=e.proxy,this._terrainDataStructure={heightScale:1/256,heightOffset:-32768,elementsPerHeight:3,stride:4,elementMultiplier:256,isBigEndian:!0,lowestEncodedHeight:0,highestEncodedHeight:16777215},this._errorEvent=new Cesium.Event;var r=e.credit;"string"==typeof r&&(r=new Cesium.Credit(r)),this._credit=r,this._readyPromise=Promise.resolve(!0),this._terrainPromises={}}XRVideoFrame.IMAGEFORMAT_RGBA32="RGBA32",XRVideoFrame.IMAGEFORMAT_BGRA32="BGRA32",XRVideoFrame.IMAGEFORMAT_RGB24="RGB24",XRVideoFrame.IMAGEFORMAT_BGR24="BGR24",XRVideoFrame.IMAGEFORMAT_GRAY8="GRAY8",XRVideoFrame.IMAGEFORMAT_YUV444P="YUV444P",XRVideoFrame.IMAGEFORMAT_YUV422P="YUV422P",XRVideoFrame.IMAGEFORMAT_YUV420P="YUV420P",XRVideoFrame.IMAGEFORMAT_YUV420SP_NV12="YUV420SP_NV12",XRVideoFrame.IMAGEFORMAT_YUV420SP_NV21="YUV420SP_NV21",XRVideoFrame.IMAGEFORMAT_HSV="HSV",XRVideoFrame.IMAGEFORMAT_Lab="Lab",XRVideoFrame.IMAGEFORMAT_DEPTH="DEPTH",XRVideoFrame.IMAGEFORMAT_NULL="",XRVideoFrame.IMAGEFORMAT=[XRVideoFrame.IMAGEFORMAT_RGBA32,XRVideoFrame.IMAGEFORMAT_BGRA32,XRVideoFrame.IMAGEFORMAT_RGB24,XRVideoFrame.IMAGEFORMAT_BGR24,XRVideoFrame.IMAGEFORMAT_GRAY8,XRVideoFrame.IMAGEFORMAT_YUV444P,XRVideoFrame.IMAGEFORMAT_YUV422P,XRVideoFrame.IMAGEFORMAT_YUV420P,XRVideoFrame.IMAGEFORMAT_YUV420SP_NV12,XRVideoFrame.IMAGEFORMAT_YUV420SP_NV21,XRVideoFrame.IMAGEFORMAT_HSV,XRVideoFrame.IMAGEFORMAT_Lab,XRVideoFrame.IMAGEFORMAT_DEPTH,XRVideoFrame.IMAGEFORMAT_NULL],Object.defineProperties(MapzenTerrariumTerrainProvider.prototype,{errorEvent:{get:function(){return this._errorEvent}},credit:{get:function(){return this._credit}},tilingScheme:{get:function(){return this._tilingScheme}},ready:{get:function(){return!0}},readyPromise:{get:function(){return this._readyPromise}},hasWaterMask:{get:function(){return!1}},hasVertexNormals:{get:function(){return!1}}}),MapzenTerrariumTerrainProvider.prototype.requestTileGeometry=function(e,t,r,i){var a=this._url+r+"/"+e+"/"+t+".png",n=this._proxy;Cesium.defined(n)&&(a=n.getURL(a));var s=this._resource.getDerivedResource({url:a,queryParameters:{cesium:!0},request:i}).fetchImage({preferImageBitmap:!0});if(Cesium.defined(s)){var o=this;return s.then(function(e){return new Cesium.HeightmapTerrainData({buffer:Cesium.getImagePixels(e,o._heightmapWidth,o._heightmapWidth),width:o._heightmapWidth,height:o._heightmapWidth,childTileMask:r<16?0:15,structure:o._terrainDataStructure})})}},MapzenTerrariumTerrainProvider.prototype.getLevelMaximumGeometricError=function(e){return this._levelZeroMaximumGeometricError/(1<<e)},MapzenTerrariumTerrainProvider.prototype.getTileDataAvailable=function(e,t,r){return r<16||void 0};var __XRDevice_requestSession=XRDevice$1.prototype.requestSession;async function useSession(e){_XRsession=e,_eastUpSouthToFixedFrame||(_eastUpSouthToFixedFrame=Cesium.Transforms.localFrameToFixedFrameGenerator("east","up")),defaultTerrainProvider||(defaultTerrainProvider=new MapzenTerrariumTerrainProvider({url:"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/",requestWaterMask:!0,requestVertexNormals:!0}));try{await e.requestFrameOfReference("head-model");return _eyeLevelFrameOfReference=await e.requestFrameOfReference("eye-level"),"geolocation"in navigator?(_watchID=navigator.geolocation.watchPosition(updatePositionCallback,geoErrorCallback,_geo_options),!0):!1}catch(e){return console.error("Can't start geolocation to XR mapping",e),!1}}XRDevice$1.prototype.requestSession=async function(e){let t=__XRDevice_requestSession.bind(this),r=await t(e);if(window.hasOwnProperty("Cesium")&&e.alignEUS&&e.geolocation){const e=()=>{_XRsession=null,_watchID&&(navigator.geolocation.clearWatch(_watchID),_watchID=0),resetState(),r.removeEventListener("end",e)};r.addEventListener("end",e),await useSession(r)}return r};const _geo_options={enableHighAccuracy:!0,maximumAge:3e4},_identity=create$2();var _scratchVec3=create$3(),_scratch2Vec3=create$3(),_scratchMat4=create$2(),_scratchMat3=create$5(),_scratchCartesian=null,_XRsession=null,_geoOrigin=null,_geoOriginAnchor=null,_geoCartesian=null,_geoAnchorsWaiting=[],_eastUpSouthToFixedFrame=null,_fixedToLocal=create$2(),_localToFixed=create$2(),_eyeLevelFrameOfReference=null,_overrideGeolocation=!1,_overrideCartesian=null,_overrideLocationAnchor=null,_overrideGeoOrientation=!1,_overrideOrientationAnchor=null,_watchID=0;function currentGeoOriginAnchor(){return _overrideGeolocation?_overrideLocationAnchor:_geoOriginAnchor}function currentGeoOriginCartesian(){}function resetState(){_geoOrigin=null,_geoOriginAnchor=null,_overrideGeolocation=!1,_overrideGeoOrientation=!1,_geoAnchorsWaiting=[]}var _altScratchCart=null;async function getAltitude(e){return _altScratchCart=Cesium.Cartographic.clone(e,_altScratchCart),await updateHeightFromTerrain(_altScratchCart),_altScratchCart.height}var defaultTerrainProvider=null;function updateHeightFromTerrain(e){return Promise.resolve(Cesium.sampleTerrain(defaultTerrainProvider,15,[e]).then(e=>e[0]))}async function cartesianToFixed(e,t,r=null){if(!r){let i=Cesium.Cartographic.fromDegrees(e,t);r=await getAltitude(i)}return Cesium.Cartesian3.fromDegrees(e,t,r)}function updateECEFToLocal(e){_eastUpSouthToFixedFrame(e,void 0,_localToFixed),Cesium.Matrix4.inverseTransformation(_localToFixed,_fixedToLocal)}function sendNewGeoAnchorEvent(e,t){try{e.dispatchEvent("newGeoAnchor",{oldAnchor:e,newAnchor:t})}catch(e){console.error("newGeoAnchor event error",e)}}function updateGeoCartesian(e,t){updateECEFToLocal(e);for(let e=0;e<_geoAnchorsWaiting.length;e++){const t=_geoAnchorsWaiting[e];try{t()}catch(e){console.error("lazy finalization of geoanchor failed: ",e)}}_geoAnchorsWaiting=[];try{t.dispatchEvent("updateCartesian")}catch(e){console.error("updateCartesian event error",e)}}var _useEstimatedElevationForViewer=!1,_savedViewHeight=0;async function _useEstimatedElevation(e){let t=function(e){return new Promise(t=>setTimeout(t,e))};if(_useEstimatedElevationForViewer!=e&&(_useEstimatedElevationForViewer=e,_geoOrigin))for(_useEstimatedElevationForViewer&&(_geoOrigin.coords.altitude=_saveViewHeight);_updateOrigin;)await t(1),await updatePositionCallback(_geoOrigin,!0)}var _updatingOrigin=!1,_scratchCartographic=null;async function updatePositionCallback(e,t=!1){if(!_updatingOrigin&&(!_geoOrigin||t||_geoOrigin.coords.accuracy>e.coords.accuracy||_geoOrigin.coords.accuracy==e.coords.accuracy&&_geoOrigin.coords.altitudeAccuracy>e.coords.altitudeAccuracy)){_updatingOrigin=!0,e={timestamp:e.timestamp,coords:{altitude:e.coords.altitude,latitude:e.coords.latitude,longitude:e.coords.longitude,accuracy:e.coords.accuracy,altitudeAccuracy:e.coords.altitudeAccuracy,heading:e.coords.heading,speed:e.coords.speed}};try{_useEstimatedElevationForViewer&&(_savedViewHeight=e.coords.altitude,_scratchCartographic=Cesium.Cartographic.fromDegrees(e.coords.longitude,e.coords.latitude,e.coords.altitude),await updateHeightFromTerrain(_scratchCartographic),e.coords.altitude=_scratchCartographic.height);let t=await _XRsession.requestFrameOfReference("head-model"),r=await _XRsession.addAnchor(_identity,t);r._isInternalGeoAnchor=!0,!_overrideGeolocation&&_geoOriginAnchor&&(sendNewGeoAnchorEvent(_geoOriginAnchor,r),await _XRsession.removeAnchor(_geoOriginAnchor)),_geoOriginAnchor=r,_geoOrigin=e,_geoCartesian=await cartesianToFixed(e.coords.longitude,e.coords.latitude,e.coords.altitude),_overrideGeolocation||updateGeoCartesian(_geoCartesian,_geoOriginAnchor),_updatingOrigin=!1}catch(e){_updatingOrigin=!1,console.error("error setting the geospatial origin: ",e)}}}function geoErrorCallback(e){e.code,console.error("watchPosition failed: ",e.message)}function generateUID(){return"geoAnchor-"+(new Date).getTime()+"-"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}function enqueueOrExec(e){_geoOrigin?e():_geoAnchorsWaiting.push(e)}class XRGeospatialAnchor extends XRAnchor{constructor(e){let t=generateUID();super(_identity,t),this._cartographic=e,this._localCartesian=create$3(),this._cartesian=Cesium.Cartographic.toCartesian(e),this._newGeoOriginNotifier=this._newGeoAnchor.bind(this),this._updateCartesianNotifier=this._updateLocalCartesian.bind(this),this._updateLocalNotifier=this._updateLocalMatrix.bind(this);let r=currentGeoOriginAnchor();r.addEventListener("newGeoAnchor",this._newGeoOriginNotifier),r.addEventListener("updateCartesian",this._updateCartesianNotifier),r.addEventListener("update",this._updateLocalNotifier),this._updateLocalCartesian()}get cartesian(){return this._cartesian}get cartographic(){return this._cartographic}_newGeoAnchor(e){e.oldAnchor.removeEventListener("newGeoAnchor",this._newGeoOriginNotifier),e.oldAnchor.removeEventListener("updateCartesian",this._updateCartesianNotifier),e.oldAnchor.removeEventListener("update",this._updateLocalNotifier),e.newAnchor.addEventListener("newGeoAnchor",this._newGeoOriginNotifier),e.newAnchor.addEventListener("updateCartesian",this._updateCartesianNotifier),e.newAnchor.addEventListener("update",this._updateLocalNotifier)}_updateLocalCartesian(){set$3(_scratchVec3,this._cartesian.x,this._cartesian.y,this._cartesian.z),transformMat4$1(this._localCartesian,_scratchVec3,_fixedToLocal),_overrideGeoOrientation&&(fromMat4(_scratchMat3,_overrideOrientationAnchor.modelMatrix),transformMat3$1(_this._localCartesian,this._localCartesian,_scratchMat3)),this._updateLocalMatrix()}_updateLocalMatrix(){getTranslation$1(_scratchVec3,currentGeoOriginAnchor().modelMatrix),add$3(_scratchVec3,_scratchVec3,this._localCartesian),fromTranslation$1(_scratchMat4,_scratchVec3),super.updateModelMatrix(_scratchMat4,currentGeoOriginAnchor.timeStamp)}static getGeoOriginPose(){return currentGeoOriginAnchor()?currentGeoOriginAnchor().modelMatrix:_identity}static getOriginCartesian(){return currentGeoOriginCartesian()}static createGeoAnchor(e){return new Promise((t,r)=>{if(!window.hasOwnProperty("Cesium")){var i="must load Cesium.js for XRGeospatialAnchor to work";console.error(i),r(i)}enqueueOrExec(()=>{t(new XRGeospatialAnchor(e))})})}static useEstimatedElevation(e){_useEstimatedElevation(e)}static overrideGeoOrientation(e){_overrideGeoOrientation=!0,_overrideOrientationAnchor=e}static overrideGeoLocation(e,t){!_overrideGeolocation&&_geoOriginAnchor?sendNewGeoAnchorEvent(_geoOriginAnchor,t):_overrideGeolocation&&sendNewGeoAnchorEvent(_overrideLocationAnchor,t),_overrideGeolocation=!0,updateGeoCartesian(_overrideCartesian=e,_overrideLocationAnchor=t)}static overrideGeoLocationOrientation(e,t){!_overrideGeolocation&&_geoOriginAnchor?sendNewGeoAnchorEvent(_geoOriginAnchor,t):_overrideGeolocation&&sendNewGeoAnchorEvent(_overrideLocationAnchor,t),_overrideGeoOrientation=!0,_overrideOrientationAnchor=t,_overrideGeolocation=!0,updateGeoCartesian(_overrideCartesian=e,_overrideLocationAnchor=t)}static useDeviceGeolocation(){_overrideGeolocation&&_geoOriginAnchor&&sendNewGeoAnchorEvent(_overrideLocationAnchor,_geoOriginAnchor),_overrideGeoOrientation=!1,_overrideOrientationAnchor=null,_overrideGeolocation=!1,_overrideCartesian=null,_overrideLocationAnchor=null,_geoOrigin&&updateGeoCartesian(_geoCartesian,_geoOriginAnchor)}static async getDefaultElevation(e){return await getAltitude(e)}static getDeviceElevation(){return new Promise((e,t)=>{enqueueOrExec(()=>{_XRsession.requestFrameOfReference("head-model").then(t=>{t.getTransformTo(_eyeLevelFrameOfReference,_scratchMat4),getTranslation$1(_scratchVec3,_scratchMat4);let r=_scratchVec3[1];getTranslation$1(_scratchVec3,currentGeoOriginAnchor().modelMatrix);let i=r-_scratchVec3[1];e(_geoOrigin.coords.altitude+i)})})})}static async getDeviceCartographic(){return new Promise((e,t)=>{enqueueOrExec(()=>{_XRsession.requestFrameOfReference("head-model").then(t=>{t.getTransformTo(_eyeLevelFrameOfReference,_scratchMat4),getTranslation$1(_scratchVec3,_scratchMat4),getTranslation$1(_scratch2Vec3,currentGeoOriginAnchor().modelMatrix),subtract$3(_scratchVec3,_scratchVec3,_scratch2Vec3),transformMat4$1(_scratchVec3,_scratchVec3,_localToFixed),_scratchCartesian=Cesium.Cartesian3.unpack(_scratchVec3,0,_scratchCartesian),e(Cesium.Cartographic.fromCartesian(_scratchCartesian))})})})}}var API$1={XRAnchor:XRAnchor,XRAnchorOffset:XRAnchorOffset,XRFaceMesh:XRFaceMesh,XRHitResult:XRHitResult,XRImageAnchor:XRImageAnchor,XRLightEstimate:XRLightEstimate,XRMesh:XRMesh,XRPlaneMesh:XRPlaneMesh,XRVideoFrame:XRVideoFrame,XRGeospatialAnchor:XRGeospatialAnchor};class PolyfilledXRDevice extends EventTarget{constructor(e){super(),this.global=e,this.onWindowResize=this.onWindowResize.bind(this),this.global.window.addEventListener("resize",this.onWindowResize),this.environmentBlendMode="opaque"}get depthNear(){throw new Error("Not implemented")}set depthNear(e){throw new Error("Not implemented")}get depthFar(){throw new Error("Not implemented")}set depthFar(e){throw new Error("Not implemented")}onBaseLayerSet(e,t){throw new Error("Not implemented")}supportsSession(e={}){throw new Error("Not implemented")}async requestSession(e={}){throw new Error("Not implemented")}requestAnimationFrame(e){throw new Error("Not implemented")}onFrameStart(e){throw new Error("Not implemented")}onFrameEnd(e){throw new Error("Not implemented")}requestStageBounds(){throw new Error("Not implemented")}async requestFrameOfReferenceTransform(e,t){}cancelAnimationFrame(e){throw new Error("Not implemented")}endSession(e){throw new Error("Not implemented")}getViewport(e,t,r,i){throw new Error("Not implemented")}getProjectionMatrix(e){throw new Error("Not implemented")}getBasePoseMatrix(){throw new Error("Not implemented")}getBaseViewMatrix(e){throw new Error("Not implemented")}getInputSources(){throw new Error("Not implemented")}getInputPose(e,t){throw new Error("Not implemented")}onWindowResize(){this.onWindowResize()}}let throttle=function(e,t,r=!0,i=!0){var a,n,s,o,c=0,h=function(){c=!1===r?0:Date.now(),a=null,o=e.apply(n,s),a||(n=s=null)},l=function(){var l=Date.now();c||!1!==r||(c=l);var d=t-(l-c);return n=this,s=arguments,d<=0||d>t?(a&&(clearTimeout(a),a=null),c=l,o=e.apply(n,s),a||(n=s=null)):a||!1===i||(a=setTimeout(h,d)),o};return l.cancel=function(){clearTimeout(a),c=0,a=n=s=null},l},throttledConsoleLog=throttle(function(...e){console.log(...e)},1e3);const PI_OVER_180=Math.PI/180;class ARKitWrapper extends EventTarget{constructor(){if(super(),!1===ARKitWrapper.HasARKit())throw new Error("ARKitWrapper will only work in Mozilla's ARDemo test app");if(void 0!==ARKitWrapper.GLOBAL_INSTANCE)throw new Error("ARKitWrapper is a singleton. Use ARKitWrapper.GetOrCreate() to get the global instance.");this._timestamp=0,this._lightIntensity=new XRLightEstimate,this._deviceId=null,this._isWatching=!1,this._waitingForSessionStart=!1,this._isInitialized=!1,this._rawARData=null,this._rAF_callback=null,this._rAF_callbackParams=[],this._requestedPermissions={cameraAccess:!1,worldAccess:!1},this._currentPermissions={cameraAccess:!1,worldAccess:!1},this._worldSensingState={illuminationDetectionState:!1,meshDetectionState:!1},this._worldInformation=null,this._projectionMatrix=new Float32Array(16),this._viewMatrix=new Float32Array(16),this._cameraTransform=new Float32Array(16),this._anchors=new Map,this._anchorOffsets=new Map,this._timeOffsets=[],this._timeOffset=0,this._timeOffsetComputed=!1,this._dataBeforeNext=0,this._worldMappingStatus=ARKitWrapper.WEB_AR_WORLDMAPPING_NOT_AVAILABLE,this._globalCallbacksMap={};let e=["onInit","onData"];for(let t=0;t<e.length;t++)this._generateGlobalCallback(e[t],t);this._defaultOptions={location:!0,camera:!0,objects:!0,light_intensity:!0,computer_vision_data:!1},this._m90=fromZRotation$1(create$2(),90*PI_OVER_180),this._m90neg=fromZRotation$1(create$2(),-90*PI_OVER_180),this._m180=fromZRotation$1(create$2(),180*PI_OVER_180),this._mTemp=create$2();let t=[["arkitStartRecording",ARKitWrapper.RECORD_START_EVENT],["arkitStopRecording",ARKitWrapper.RECORD_STOP_EVENT],["arkitDidMoveBackground",ARKitWrapper.DID_MOVE_BACKGROUND_EVENT],["arkitWillEnterForeground",ARKitWrapper.WILL_ENTER_FOREGROUND_EVENT],["arkitInterrupted",ARKitWrapper.INTERRUPTED_EVENT],["arkitInterruptionEnded",ARKitWrapper.INTERRUPTION_ENDED_EVENT],["arkitShowDebug",ARKitWrapper.SHOW_DEBUG_EVENT],["arkitWindowResize",ARKitWrapper.WINDOW_RESIZE_EVENT],["onError",ARKitWrapper.ON_ERROR],["arTrackingChanged",ARKitWrapper.AR_TRACKING_CHANGED]];for(let e=0;e<t.length;e++)window[t[e][0]]=(r=>{r=r||null;try{this.dispatchEvent(t[e][1],new CustomEvent(t[e][1],{source:this,detail:r}))}catch(r){console.error(t[e][0]+" callback error",r)}});window.onComputerVisionData=(e=>{this._onComputerVisionData(e)}),window.setNativeTime=(e=>{this._timeOffsets.push((performance||Date).now()-e.nativeTime),this._timeOffsetComputed=!0,this._timeOffset=0;for(var t=0;t<this._timeOffsets.length;t++)this._timeOffset+=this._timeOffsets[t];this._timeOffset=this._timeOffset/this._timeOffsets.length}),window.userGrantedComputerVisionData=(e=>{this._sessionCameraAccess|=e.granted}),window.userGrantedWorldSensingData=(e=>{this._sessionWorldAccess|=e.granted})}static GetOrCreate(e=null){if(void 0===ARKitWrapper.GLOBAL_INSTANCE){ARKitWrapper.GLOBAL_INSTANCE=new ARKitWrapper;let t={browser:!0,points:!0,focus:!1,rec:!0,rec_time:!0,mic:!1,build:!1,plane:!0,warnings:!0,anchors:!1,debug:!0,statistics:!1},r="object"==typeof(e=e&&"object"==typeof e?e:{}).ui?e.ui:{};e.ui=Object.assign(t,r),e.geometry_arrays=!0,XRMesh.setUseGeomArrays(),ARKitWrapper.GLOBAL_INSTANCE._sendInit(e)}return ARKitWrapper.GLOBAL_INSTANCE}static HasARKit(){return void 0!==window.webkit}get deviceId(){return this._deviceId}get hasSession(){return this._isWatching}get isInitialized(){return this._isInitialized}_sendInit(e){console.log("----INIT"),window.webkit.messageHandlers.initAR.postMessage({options:e,callback:this._globalCallbacksMap.onInit})}waitForInit(){return new Promise((e,t)=>{if(this._isInitialized)return void e();const r=()=>{this.removeEventListener(ARKitWrapper.INIT_EVENT,r,!1),e()};this.addEventListener(ARKitWrapper.INIT_EVENT,r,!1)})}_onInit(e){this._deviceId=e,this._isInitialized=!0;try{this.dispatchEvent(ARKitWrapper.INIT_EVENT,new CustomEvent(ARKitWrapper.INIT_EVENT,{source:this}))}catch(e){console.error("INIT_EVENT event error",e)}}hitTest(e,t,r=ARKitWrapper.HIT_TEST_TYPE_ALL){return new Promise((i,a)=>{this._isInitialized?window.webkit.messageHandlers.hitTest.postMessage({x:e,y:t,type:r,callback:this._createPromiseCallback("hitTest",i)}):a(new Error("ARKit is not initialized"))})}pickBestHit(e){if(0===e.length)return null;let t=e.filter(e=>e.type!=ARKitWrapper.HIT_TEST_TYPE_FEATURE_POINT),r=t.filter(e=>e.type==ARKitWrapper.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT),i=t.filter(e=>e.type==ARKitWrapper.HIT_TEST_TYPE_EXISTING_PLANE);return r.length?(r=r.sort((e,t)=>e.distance-t.distance))[0]:i.length?(i=i.sort((e,t)=>e.distance-t.distance))[0]:t.length?(t=t.sort((e,t)=>e.distance-t.distance))[0]:e[0]}_addAnchor(e,t){return new Promise((r,i)=>{this._isInitialized?window.webkit.messageHandlers.addAnchor.postMessage({uuid:e,transform:t,callback:this._createPromiseCallback("addAnchor",r)}):i(new Error("ARKit is not initialized"))})}createAnchor(e){return new Promise((t,r)=>{var i=new XRAnchor(e,null,this._timestamp);this._addAnchor(i.uid,e).then(e=>{if(e.error)r(e.error);else{var a=this._anchors.get(e.uuid);a?(a.placeholder=!1,a.deleted=!1,a.updateModelMatrix(e.transform,this._timestamp),t(a)):(this._anchors.set(e.uuid,i),t(i))}}).catch((...e)=>{console.error("could not create anchor",...e),r()})})}createAnchorFromHit(e){return new Promise((t,r)=>{if(e.anchor_transform){let r=this._anchors.get(e.uuid);r||(r=new XRAnchor(e.anchor_transform,e.uuid,this._timestamp),console.log("created dummy anchor from hit test"),r.placeholder=!0,this._anchors.set(e.uuid,r)),t(new XRAnchorOffset(r,e.local_transform))}else{let r=this._anchors.get(e.uuid);r?(r.placeholder=!1,r.deleted=!1,console.log("hit test resulted in a hit on an existing anchor, without an offset")):(r=new XRAnchor(e.world_transform,e.uuid),console.log("created dummy anchor (not a plane) from hit test"),r.placeholder=!0,this._anchors.set(e.uuid,r)),t(r)}})}removeAnchor(e){let t=this._anchors.get(e.uid);t.placeholder?this._anchors.delete(e.uid):(t&&(t.deleted=!0),!e instanceof XRAnchorOffset&&window.webkit.messageHandlers.removeAnchors.postMessage([e.uid]))}_createDetectionImage(e,t,r,i,a){return new Promise((n,s)=>{if(!this._isInitialized)return void s(new Error("ARKit is not initialized"));let o=base64.encode(t);window.webkit.messageHandlers.createImageAnchor.postMessage({uid:e,buffer:o,imageWidth:r,imageHeight:i,physicalWidth:a,callback:this._createPromiseCallback("createImageAnchor",n)})})}createDetectionImage(e,t,r,i,a){return new Promise((n,s)=>{this._createDetectionImage(e,t,r,i,a).then(e=>{e.error?s(e.error):e.created?n():s(null)}).catch((...e)=>{console.error("could not create image",...e),s()})})}_destroyDetectionImage(e){return new Promise((t,r)=>{this._isInitialized?window.webkit.messageHandlers.destroyImageAnchor.postMessage({uid:e,callback:this._createPromiseCallback("destroyImageAnchor",t)}):r(new Error("ARKit is not initialized"))})}destroyDetectionImage(e){return new Promise((t,r)=>{this._destroyDetectionImage(e).then(e=>{e.error?r(e.error):t()}).catch((...e)=>{console.error("could not destroy image",...e),r()})})}_activateDetectionImage(e,t=!1){return new Promise((r,i)=>{this._isInitialized?window.webkit.messageHandlers.activateDetectionImage.postMessage({uid:e,trackable:t,callback:this._createPromiseCallback("activateDetectionImage",r)}):i(new Error("ARKit is not initialized"))})}activateDetectionImage(e,t=!1){return new Promise((r,i)=>{var a=this._anchors.get(e);!a||a.deleted?this._activateDetectionImage(e,t).then(e=>{e.error&&i(e.error),e.activated?(this._createOrUpdateAnchorObject(e.imageAnchor),e.imageAnchor.object.deleted=!1,r(e.imageAnchor.object)):i(null)}).catch((...e)=>{console.error("could not activate image",...e),i()}):r(a)})}_deactivateDetectionImage(e){return new Promise((t,r)=>{this._isInitialized?window.webkit.messageHandlers.deactivateDetectionImage.postMessage({uid:e,callback:this._createPromiseCallback("deactivateDetectionImage",t)}):r(new Error("ARKit is not initialized"))})}deactivateDetectionImage(e){return new Promise((t,r)=>{this._deactivateDetectionImage(e).then(i=>{i.error&&r(i.error);var a=this._anchors.get(e);a&&(console.warn("anchor for image target '"+e+"' still exists after deactivation"),removeAnchor(a)),t()}).catch((...e)=>{console.error("could not activate image",...e),r()})})}setNumberOfTrackedImages(e){"number"!=typeof e&&(e=0),window.webkit.messageHandlers.setNumberOfTrackedImages.postMessage({numberOfTrackedImages:e})}_getWorldMap(){return new Promise((e,t)=>{this._isInitialized?window.webkit.messageHandlers.getWorldMap.postMessage({callback:this._createPromiseCallback("getWorldMap",e)}):t(new Error("ARKit is not initialized"))})}getWorldMap(){return new Promise((e,t)=>{this._getWorldMap().then(r=>{if(!0!==r.saved)return null!==r.error?void t(r.error):void t(null);e(r.worldMap)}).catch((...e)=>{console.error("could not get world map",...e),t()})})}setWorldMap(e){return new Promise((t,r)=>{this._isInitialized?window.webkit.messageHandlers.setWorldMap.postMessage({worldMap:e.worldMap,callback:this._createPromiseCallback("setWorldMap",t)}):r(new Error("ARKit is not initialized"))})}stop(){return new Promise((e,t)=>{this._isWatching?(console.log("----STOP"),window.webkit.messageHandlers.stopAR.postMessage({callback:this._createPromiseCallback("stop",e)})):e()})}watch(e=null){return new Promise((t,r)=>{if(!this._isInitialized)return void r("ARKitWrapper hasn't been initialized yet");if(this._waitingForSessionStart)return void r("ARKitWrapper startSession called, waiting to finish");if(this._isWatching)return void t({cameraAccess:this._sessionCameraAccess,worldAccess:this._sessionWorldAccess,webXRAccess:!0});this._waitingForSessionStart=!0;var i=Object.assign({},this._defaultOptions);null!=e&&(i=Object.assign(i,e)),this._requestedPermissions.cameraAccess=i.videoFrames,this._requestedPermissions.worldAccess=i.worldSensing,i.videoFrames&&(delete i.videoFrames,i.computer_vision_data=!0);const a={options:i,callback:this._createPromiseCallback("requestSession",e=>{e.webXRAccess?(this._waitingForSessionStart=!1,this._isWatching=!0,this._currentPermissions.cameraAccess=e.cameraAccess,this._currentPermissions.worldAccess=e.worldAccess,t(e)):r("user did not give permission to start a webxr session")}),data_callback:this._globalCallbacksMap.onData};console.log("----WATCH"),window.webkit.messageHandlers.requestSession.postMessage(a)})}setUIOptions(e){window.webkit.messageHandlers.setUIOptions.postMessage(e)}_createOrUpdateAnchorObject(e){var t;if(e.plane_center)if(!(t=this._anchors.get(e.uuid))||t.placeholder){var r=new XRPlaneMesh(e.transform,e.plane_center,[e.plane_extent.x,e.plane_extent.z],e.plane_alignment,e.geometry,e.uuid,this._timestamp);if(t){try{t.dispatchEvent("replaceAnchor",new CustomEvent("replaceAnchor",{source:t,detail:r}))}catch(e){console.error("replaceAnchor event error",e)}console.log("replaced dummy anchor created from hit test with plane"),this._anchors.delete(e.uuid)}this._anchors.set(e.uuid,r),e.object=r}else t&&(t.updatePlaneData(e.transform,e.plane_center,[e.plane_extent.x,e.plane_extent.y],e.plane_alignment,e.geometry,this._timestamp),e.object=t);else if(!(t=this._anchors.get(e.uuid))||t.placeholder){let r;switch(e.type){case ARKitWrapper.ANCHOR_TYPE_FACE:r=new XRFaceMesh(e.transform,e.geometry,e.blendShapes,e.uuid,this._timestamp);break;case ARKitWrapper.ANCHOR_TYPE_ANCHOR:r=new XRAnchor(e.transform,e.uuid,this._timestamp);break;case ARKitWrapper.ANCHOR_TYPE_IMAGE:r=new XRImageAnchor(e.transform,e.uuid,this._timestamp)}if(t){try{t.dispatchEvent("replaceAnchor",new CustomEvent("replaceAnchor",{source:t||mesh,detail:r}))}catch(e){console.error("replaceAnchor event error",e)}console.log("replaced dummy anchor created from hit test with new anchor")}this._anchors.set(e.uuid,r),e.object=r}else{switch(t=t,e.type){case ARKitWrapper.ANCHOR_TYPE_FACE:t.updateFaceData(e.transform,e.geometry,e.blendShapes,this._timestamp);break;default:t.updateModelMatrix(e.transform,this._timestamp)}e.object=t}}updateWorldSensingState(e){return e.hasOwnProperty("illuminationDetectionState")&&this._currentPermissions.worldAccess?this._worldSensingState.illuminationDetectionState=e.illuminationDetectionState.enabled||!1:this._worldSensingState.illuminationDetectionState=!1,e.hasOwnProperty("meshDetectionState")&&this._currentPermissions.worldAccess?this._worldSensingState.meshDetectionState=e.meshDetectionState.enabled||!1:this._worldSensingState.meshDetectionState=!1,this._worldSensingState}getWorldInformation(){if(this._worldInformation)return this._worldInformation;let e={};return this._worldSensingState.illuminationDetectionState&&(e.estimatedLight=this._lightIntensity),this._worldSensingState.meshDetectionState&&(e.meshes=[],this._anchors.forEach(t=>{!t.isMesh()||t.deleted||t.placeholder||e.meshes.push(t)})),this._worldInformation=e,e}get hasData(){return null!==this._rawARData}_getData(e=null){return e?this._rawARData&&void 0!==this._rawARData[e]?this._rawARData[e]:null:this._rawARData}requestAnimationFrame(e,...t){this._rAF_callback=e,this._rAF_callbackParams=t}_do_rAF(){if(this._rAF_callback){var e=this._rAF_callback,t=this._rAF_callbackParams;return this._rAF_callback=null,this._rAF_callbackParams=[],window.requestAnimationFrame((...r)=>{this.startingRender();try{e(...t)}catch(e){console.error("application callback error: ",e)}this.finishedRender()})}}finishedRender(){this._dataBeforeNext=0,this._anchors.forEach(e=>{e.clearChanged()})}startingRender(){this._dataBeforeNext}_onData(e){if(this._rawARData=e,this._worldInformation=null,this._timestamp=this._adjustARKitTime(e.timestamp),this._lightIntensity.ambientIntensity=e.light_intensity,copy$2(this._cameraTransform,e.camera_transform),copy$2(this._viewMatrix,e.camera_view),copy$2(this._projectionMatrix,e.projection_camera),this._worldMappingStatus=e.worldMappingStatus,e.newObjects.length)for(let r=0;r<e.newObjects.length;r++){const i=e.newObjects[r];var t;(t=this._anchors.get(i.uuid))&&t.deleted&&(t.deleted=!1),this._createOrUpdateAnchorObject(i)}if(e.removedObjects.length)for(let t=0;t<e.removedObjects.length;t++){const r=e.removedObjects[t],i=this._anchors.get(r);i?(i.notifyOfRemoval(),this._anchors.delete(r)):console.error("app signalled removal of non-existant anchor/plane")}if(e.objects.length)for(let t=0;t<e.objects.length;t++){const r=e.objects[t];this._createOrUpdateAnchorObject(r)}try{this.dispatchEvent(ARKitWrapper.WATCH_EVENT,new CustomEvent(ARKitWrapper.WATCH_EVENT,{source:this,detail:this}))}catch(e){console.error("WATCH_EVENT event error",e)}this._rAF_callback&&this._do_rAF(),this._dataBeforeNext++}_onStop(){this._isWatching=!1}_adjustARKitTime(e){return this._timeOffsetComputed?e+this._timeOffset:(performance||Date).now()}_createPromiseCallback(e,t){const r=this._generateCallbackUID(e);return window[r]=(i=>{delete window[r];const a="_on"+e[0].toUpperCase()+e.slice(1);"function"==typeof this[a]&&this[a](i),t(i)}),r}_generateCallbackUID(e){return"arkitCallback_"+e+"_"+(new Date).getTime()+"_"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}_generateGlobalCallback(e,t){const r="arkitCallback"+t;this._globalCallbacksMap[e]=r;const i=this;window[r]=function(t){i["_"+e](t)}}_onComputerVisionData(e){if(!e)return console.error("detail passed to _onComputerVisionData is null"),void this._requestComputerVisionData();if(!e.frame||!e.frame.buffers||e.frame.buffers.length<=0)return console.error("detail passed to _onComputerVisionData is bad, no buffers"),void this._requestComputerVisionData();e.camera.arCamera=!0;var t=e.camera.interfaceOrientation;switch(e.camera.viewMatrix=e.camera.inverse_viewMatrix,t){case 1:e.camera.cameraOrientation=-90;break;case 2:e.camera.cameraOrientation=90;break;case 3:e.camera.cameraOrientation=0;break;case 4:e.camera.cameraOrientation=180}switch(e.frame.pixelFormatType){case"kCVPixelFormatType_420YpCbCr8BiPlanarFullRange":e.frame.pixelFormat="YUV420P";break;default:e.frame.pixelFormat=e.frame.pixelFormatType}var r=new XRVideoFrame(e.frame.buffers,e.frame.pixelFormat,this._adjustARKitTime(e.frame.timestamp),e.camera);try{this.dispatchEvent(ARKitWrapper.COMPUTER_VISION_DATA,new CustomEvent(ARKitWrapper.COMPUTER_VISION_DATA,{source:this,detail:r}))}catch(e){console.error("COMPUTER_VISION_DATA event error",e)}}_requestComputerVisionData(){window.webkit.messageHandlers.requestComputerVisionData.postMessage({})}_startSendingComputerVisionData(){window.webkit.messageHandlers.startSendingComputerVisionData.postMessage({})}_stopSendingComputerVisionData(){window.webkit.messageHandlers.stopSendingComputerVisionData.postMessage({})}}ARKitWrapper.INIT_EVENT="arkit-init",ARKitWrapper.WATCH_EVENT="arkit-watch",ARKitWrapper.RECORD_START_EVENT="arkit-record-start",ARKitWrapper.RECORD_STOP_EVENT="arkit-record-stop",ARKitWrapper.DID_MOVE_BACKGROUND_EVENT="arkit-did-move-background",ARKitWrapper.WILL_ENTER_FOREGROUND_EVENT="arkit-will-enter-foreground",ARKitWrapper.INTERRUPTED_EVENT="arkit-interrupted",ARKitWrapper.INTERRUPTION_ENDED_EVENT="arkit-interruption-ended",ARKitWrapper.SHOW_DEBUG_EVENT="arkit-show-debug",ARKitWrapper.WINDOW_RESIZE_EVENT="arkit-window-resize",ARKitWrapper.ON_ERROR="on-error",ARKitWrapper.AR_TRACKING_CHANGED="ar_tracking_changed",ARKitWrapper.COMPUTER_VISION_DATA="cv_data",ARKitWrapper.USER_GRANTED_COMPUTER_VISION_DATA="user-granted-cv-data",ARKitWrapper.USER_GRANTED_WORLD_SENSING_DATA="user-granted-world-sensing-data",ARKitWrapper.ORIENTATION_UP=1,ARKitWrapper.ORIENTATION_UP_MIRRORED=2,ARKitWrapper.ORIENTATION_DOWN=3,ARKitWrapper.ORIENTATION_DOWN_MIRRORED=4,ARKitWrapper.ORIENTATION_LEFT_MIRRORED=5,ARKitWrapper.ORIENTATION_RIGHT=6,ARKitWrapper.ORIENTATION_RIGHT_MIRRORED=7,ARKitWrapper.ORIENTATION_LEFT=8,ARKitWrapper.WEB_AR_WORLDMAPPING_NOT_AVAILABLE="ar_worldmapping_not_available",ARKitWrapper.WEB_AR_WORLDMAPPING_LIMITED="ar_worldmapping_limited",ARKitWrapper.WEB_AR_WORLDMAPPING_EXTENDING="ar_worldmapping_extending",ARKitWrapper.WEB_AR_WORLDMAPPING_MAPPED="ar_worldmapping_mapped",ARKitWrapper.HIT_TEST_TYPE_FEATURE_POINT=1,ARKitWrapper.HIT_TEST_TYPE_ESTIMATED_HORIZONTAL_PLANE=2,ARKitWrapper.HIT_TEST_TYPE_ESTIMATED_VERTICAL_PLANE=4,ARKitWrapper.HIT_TEST_TYPE_EXISTING_PLANE=8,ARKitWrapper.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT=16,ARKitWrapper.HIT_TEST_TYPE_EXISTING_PLANE_USING_GEOMETRY=32,ARKitWrapper.HIT_TEST_TYPE_ALL=ARKitWrapper.HIT_TEST_TYPE_FEATURE_POINT|ARKitWrapper.HIT_TEST_TYPE_EXISTING_PLANE|ARKitWrapper.HIT_TEST_TYPE_ESTIMATED_HORIZONTAL_PLANE|ARKitWrapper.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT,ARKitWrapper.HIT_TEST_TYPE_EXISTING_PLANES=ARKitWrapper.HIT_TEST_TYPE_EXISTING_PLANE|ARKitWrapper.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT,ARKitWrapper.ANCHOR_TYPE_PLANE="plane",ARKitWrapper.ANCHOR_TYPE_FACE="face",ARKitWrapper.ANCHOR_TYPE_ANCHOR="anchor",ARKitWrapper.ANCHOR_TYPE_IMAGE="image";class ARKitWatcher{constructor(e){this._subscribed=!1,this._arKitWrapper=e,this.subscribe()}subscribe(){this._subscribed||(this._subscribed=!0,this._arKitWrapper.addEventListener(ARKitWrapper.INIT_EVENT,this.handleARKitInit.bind(this)),this._arKitWrapper.addEventListener(ARKitWrapper.WATCH_EVENT,this.handleARKitUpdate.bind(this)),this._arKitWrapper.addEventListener(ARKitWrapper.WINDOW_RESIZE_EVENT,this.handleARKitWindowResize.bind(this)),this._arKitWrapper.addEventListener(ARKitWrapper.ON_ERROR,this.handleOnError.bind(this)),this._arKitWrapper.addEventListener(ARKitWrapper.AR_TRACKING_CHANGED,this.handleArTrackingChanged.bind(this)),this._arKitWrapper.addEventListener(ARKitWrapper.COMPUTER_VISION_DATA,this.handleComputerVisionData.bind(this)))}handleARKitInit(){}handleARKitUpdate(){}handleARKitWindowResize(){}handleOnError(){}handleArTrackingChanged(){}handleComputerVisionData(){}}window.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{try{var e=document.createElement("style");document.head.appendChild(e);var t=e.sheet;t.insertRule(".arkit-device-wrapper { z-index: -1; }",0),t.insertRule(".arkit-device-wrapper, .xr-canvas { position: absolute; top: 0; left: 0; bottom: 0; right: 0; }",0),t.insertRule(".arkit-device-wrapper, .arkit-device-wrapper canvas { width: 100%; height: 100%; padding: 0; margin: 0; -webkit-user-select: none; user-select: none; }",0)}catch(e){console.error("page error",e)}},1)});class ARKitDevice extends PolyfilledXRDevice{constructor(e){super(e),this._throttledLogPose=throttle(this.logPose,1e3),this._sessions=new Map,this._activeSession=null,this._wrapperDiv=document.createElement("div"),this._wrapperDiv.setAttribute("class","arkit-device-wrapper"),document.addEventListener("DOMContentLoaded",e=>{document.body.insertBefore(this._wrapperDiv,document.body.firstChild||null)}),this._headModelMatrix=create$2(),this._projectionMatrix=create$2(),this._eyeLevelMatrix=identity$1(create$2()),this._stageMatrix=identity$1(create$2()),this._stageMatrix[13]=-1.3,this._baseFrameSet=!1,this._frameOfRefRequestsWaiting=[],this._depthNear=.1,this._depthFar=1e3;try{this._arKitWrapper=ARKitWrapper.GetOrCreate(),this._arWatcher=new ARWatcher(this._arKitWrapper,this)}catch(e){console.error("Error initializing the ARKit wrapper",e),this._arKitWrapper=null,this._arWatcher=null}}get depthNear(){return this._depthNear}set depthNear(e){this._depthNear=e}get depthFar(){return this._depthFar}set depthFar(e){this._depthFar=e}supportsSession(e={}){return!(!e.hasOwnProperty("alignEUS")&&e.hasOwnProperty("geolocation")&&!e.hasOwnProperty("immersive"))}async requestSession(e={}){if(!this.supportsSession(e))return console.error("Invalid session options",e),Promise.reject();if(!this._arKitWrapper)return console.error("Session requested without an ARKitWrapper"),Promise.reject();if(null!==this._activeSession)return console.error("Tried to start a second active session"),Promise.reject();var t={};e.hasOwnProperty("worldSensing")&&(t.worldSensing=e.worldSensing),e.hasOwnProperty("computerVision")&&(t.videoFrames=e.useComputerVision),e.hasOwnProperty("alignEUS")&&(t.alignEUS=e.alignEUS);var r=!1;e.hasOwnProperty("geolocation")&&e.hasOwnProperty("alignEUS")&&(r=!0);await this._arKitWrapper.waitForInit().then(()=>{}).catch((...e)=>(console.error("app failed to initialize: ",...e),Promise.reject()));return await this._arKitWrapper.watch(t).then(t=>{const i=new Session(e.outputContext||null);return this._sessions.set(i.id,i),this._activeSession=i,i._useGeolocation=r,Promise.resolve(i.id)}).catch((...e)=>(console.error("session request failed: ",...e),Promise.reject()))}onBaseLayerSet(e,t){this._sessions.get(e).baseLayer=t,this._wrapperDiv.appendChild(t.context.canvas),t.context.canvas.style.width="100%",t.context.canvas.style.height="100%"}requestAnimationFrame(e,...t){this._arKitWrapper.requestAnimationFrame(e,t)}cancelAnimationFrame(e){return window.cancelAnimationFrame(e)}onFrameStart(e){}onFrameEnd(e){}logPose(){console.log("pose",getTranslation$1(new Float32Array(3),this._headModelMatrix),getRotation$1(new Float32Array(4),this._headModelMatrix))}requestFrameOfReferenceTransform(e,t){var r=this;return new Promise((t,i)=>{let a=function(e){r._baseFrameSet?e():r._frameOfRefRequestsWaiting.push(e)};switch(e){case"head-model":return void a(function(){t(r._headModelMatrix)});case"eye-level":return void a(function(){t(r._eyeLevelMatrix)});case"stage":i(new Error("stage not supported",e));default:i(new Error("Unsupported frame of reference type",e))}})}endSession(e){const t=this._sessions.get(e);t&&!t.ended&&(t.ended=!0,this._activeSession===t&&(this._activeSession=null,this._arKitWrapper.stop()),null!==t.baseLayer&&this._wrapperDiv.removeChild(t.baseLayer.context.canvas),t._useGeolocation&&XRGeospatialAnchor.closeSession())}getViewport(e,t,r,i){const{offsetWidth:a,offsetHeight:n}=r.context.canvas;return i.x=0,i.y=0,i.width=a,i.height=n,!0}getProjectionMatrix(e){return this._projectionMatrix}setProjectionMatrix(e){copy$2(this._projectionMatrix,e)}getBasePoseMatrix(){return this._headModelMatrix}getBaseViewMatrix(e){return this._headModelMatrix}setBaseViewMatrix(e){if(copy$2(this._headModelMatrix,e),!this._baseFrameSet){this._baseFrameSet=!0;for(let e=0;e<this._frameOfRefRequestsWaiting.length;e++){const t=this._frameOfRefRequestsWaiting[e];try{t()}catch(e){console.error("finalization of reference frame requests failed: ",e)}}this._frameOfRefRequestsWaiting=[]}}requestStageBounds(){return null}getInputSources(){return[]}getInputPose(e,t){return null}onWindowResize(){this._sessions.forEach((e,t)=>{})}}let SESSION_ID=100;class Session{constructor(e){this.ended=null,this.outputContext=e,this.baseLayer=null,this.id=++SESSION_ID}}class ARWatcher extends ARKitWatcher{constructor(e,t){super(e),this._arKitDevice=t}handleARKitUpdate(e){this._arKitDevice.setBaseViewMatrix(this._arKitWrapper._cameraTransform),this._arKitDevice.setProjectionMatrix(this._arKitWrapper._projectionMatrix)}handleOnError(...e){console.error("ARKit error",...e)}}const _workingMatrix=create$2(),_workingMatrix2=create$2();WebXRPolyfill.prototype._patchRequestDevice=function(){var e=new ARKitDevice(this.global);this.xr=new XR(new XRDevice(e)),this.xr._mozillaXRViewer=!0,Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})};const xrPolyfill=new WebXRPolyfill(null,{webvr:!1,cardboard:!1});function _xrFrameOfReferenceGetTransformTo(e,t){return _getTransformTo(this[PRIVATE$9].transform,e[PRIVATE$9].transform,t)}function _getTransformTo(e,t,r){return invert$1(_workingMatrix,t),multiply$2(r,e,_workingMatrix)}const _arKitWrapper=ARKitWrapper.GetOrCreate();function _updateWorldSensingState(e){return _arKitWrapper.updateWorldSensingState(e)}function _getWorldInformation(){return _arKitWrapper.getWorldInformation()}async function _xrSessionRequestHitTest(e,t,r){return"head-model"!==r.type?Promise.reject("Only head-model hit testing is supported"):0!=e[0]&&0!=e[1]&&0!=e[2]?Promise.reject("Platform only supports hit testing with ray origin = [0,0,0]"):new Promise((e,i)=>{const a=_convertRayToARKitScreenCoordinates(t,_arKitWrapper._projectionMatrix);_arKitWrapper.hitTest(...a,ARKitWrapper.HIT_TEST_TYPE_EXISTING_PLANE_USING_GEOMETRY).then(t=>{0===t.length&&e([]),this.requestFrameOfReference("eye-level").then(i=>{i.getTransformTo(r,_workingMatrix),e(t.map(e=>(multiply$2(_workingMatrix2,_workingMatrix,e.world_transform),new XRHitResult(_workingMatrix2,e,_arKitWrapper._timestamp))))}).catch((...e)=>{console.error("Error testing for hits",...e),i()})}).catch((...e)=>{console.error("Error testing for hits",...e),i()})})}async function _addAnchor(e,t){return e instanceof XRHitResult?_arKitWrapper.createAnchorFromHit(e._hit):e instanceof Float32Array?new Promise((r,i)=>{this.requestFrameOfReference("eye-level").then(a=>{t.getTransformTo(a,_workingMatrix);const n=multiply$2(create$2(),_workingMatrix,e);_arKitWrapper.createAnchor(n).then(e=>{r(e)}).catch((...e)=>{console.error("could not create anchor",...e),i()})}).catch((...e)=>{console.error("could not create eye-level frame of reference",...e),i()})}):Promise.reject("invalid value passed to addAnchor",e)}async function _removeAnchor(e){return new Promise((t,r)=>{_arKitWrapper.removeAnchor(e),t()})}function _setNumberOfTrackedImages(e){return _arKitWrapper.setNumberOfTrackedImages(e)}function _createDetectionImage(e,t,r,i,a){return _arKitWrapper.createDetectionImage(e,t,r,i,a)}function _destroyDetectionImage(e){return _arKitWrapper.createDetectionImage(e)}function _activateDetectionImage(e){return _arKitWrapper.activateDetectionImage(e)}function _deactivateDetectionImage(e){return _arKitWrapper.deactivateDetectionImage(e)}function _getWorldMap(){return _arKitWrapper.getWorldMap()}function _setWorldMap(e){return _arKitWrapper.setWorldMap(e)}function _getWorldMappingStatus(){return _arKitWrapper._worldMappingStatus}function _convertRayToARKitScreenCoordinates(e,t){var r=transformMat4$1(create$3(),e,t);return[(r[0]+1)/2,(1-r[1])/2]}function _installExtensions(){if(navigator.xr){window.XRSession&&(XRSession.prototype.requestHitTest=_xrSessionRequestHitTest,XRSession.prototype.updateWorldSensingState=_updateWorldSensingState,XRSession.prototype.addAnchor=_addAnchor,XRSession.prototype.removeAnchor=_removeAnchor,XRSession.prototype.nonStandard_createDetectionImage=_createDetectionImage,XRSession.prototype.nonStandard_destroyDetectionImage=_destroyDetectionImage,XRSession.prototype.nonStandard_activateDetectionImage=_activateDetectionImage,XRSession.prototype.nonStandard_deactivateDetectionImage=_deactivateDetectionImage,XRSession.prototype.nonStandard_setNumberOfTrackedImages=_setNumberOfTrackedImages,XRSession.prototype.nonStandard_getWorldMap=_getWorldMap,XRSession.prototype.nonStandard_setWorldMap=_setWorldMap,XRSession.prototype.nonStandard_getWorldMappingStatus=_getWorldMappingStatus),window.XRFrame&&Object.defineProperty(XRFrame.prototype,"worldInformation",{get:_getWorldInformation}),window.XRFrameOfReference&&(XRFrameOfReference.prototype.getTransformTo=_xrFrameOfReferenceGetTransformTo);for(const e of Object.keys(API$1))void 0!==window[e]?console.warn(`${e} already defined on global.`):window[e]=API$1[e]}}_installExtensions();
